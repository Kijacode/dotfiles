/*
 * quokka-vscode - v1.0.386
 * Copyright (c) 2017-2021 WallabyJs - All Rights Reserved.
 */

!function e(t,s,i){process.env.WALLABY_PRODUCTION=!0;var a="function"==typeof require&&require;module.exports=function o(n,r){if(!s[n]){if(!t[n]){var l="function"==typeof require&&require;if(!r&&l)return l(n,!0);if(a)return a(n,!0);var c=new Error("Cannot find module '"+n+"'");throw c.code="MODULE_NOT_FOUND",c}var h=s[n]={exports:{}};t[n][0].call(h.exports,function(e){var s=t[n][1][e];return o(s||e)},h,h.exports,e,t,s,i)}return s[n].exports}(i[0])}({1:[function(e,t,s){"use strict";var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))(function(a,o){function n(e){try{l(i.next(e))}catch(e){o(e)}}function r(e){try{l(i.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(n,r)}l((i=i.apply(e,t||[])).next())})};let a=e("os"),o=e("fs"),n=e("path"),r=e("vscode"),l=e("vsls/vscode"),c=e("./lib/compositeDisposable"),h=r.window,u="quokkajs";const d=e("./lib/startViewPanel");class _{activate(t){return i(this,void 0,void 0,function*(){r.window.registerWebviewPanelSerializer&&r.window.registerWebviewPanelSerializer(d.viewType,{deserializeWebviewPanel(e,s){return i(this,void 0,void 0,function*(){d.revive(e,t)})}});let s=this;s._disposables=new c,s._setupStatusIndicator();let a=e(t.globalState.get("corePath")),o={context:t,coreClient:a,statusBar:s._statusBar,deactivate:()=>s.deactivate(),version:_._getVersion()},n=yield l.getApiAsync(),h=e("./lib/controller");s._controller=new h(o,n,u),s._controller.activate(),s._disposables.add(()=>s._controller.deactivate()),s._disposables.add(()=>n&&n.unshareService(u))})}static _getVersion(){let e=1,t=0;try{let s=r.version.split(".");e=parseInt(s[0],10),t=parseInt(s[1],10)}catch(e){}return{major:e,minor:t}}_setupStatusIndicator(){this._startPageIndicator=h.createStatusBarItem(r.StatusBarAlignment.Left,Number.NEGATIVE_INFINITY),this._startPageIndicator.text="Quokka",this._startPageIndicator.tooltip="Quokka (click to open start view)",this._startPageIndicator.command="quokka.openStartView",this._startPageIndicator.show(),r.workspace.getConfiguration().get("quokka.startViewStatusBar",!0)||this._startPageIndicator.hide(),r.workspace.onDidChangeConfiguration(e=>{r.workspace.getConfiguration().get("quokka.startViewStatusBar",!0)?this._startPageIndicator.show():this._startPageIndicator.hide()});let e=this;e._statusBar=h.createStatusBarItem(r.StatusBarAlignment.Right,Number.NEGATIVE_INFINITY),e._statusBar.show();let t=e._statusBar.hide.bind(e._statusBar),s=e._statusBar.dispose.bind(e._statusBar);e._statusBar.hide=(()=>{e._statusBar.stopProgress(),e._statusBar._mainText="",e._statusBar._extensionText="",e._statusBar.updateText(),t()}),e._statusBar.dispose=(()=>{e._statusBar.stopProgress(),s()}),e._statusBar.displayProgress=(()=>{let t=0,s=["[=-----]","[-=----]","[--=---]","[---=--]","[----=-]","[-----=]","[----=-]","[---=--]","[--=---]","[-=----]"];clearInterval(e._statusBar._progress),e._statusBar._progress=setInterval(()=>{e._statusBar.setMainText(`${s[t=++t%s.length]}   `),e._statusBar._doUpdateText()},150)}),e._statusBar.setMainText=(t=>{e._statusBar._mainText=t}),e._statusBar.setExtensionText=(t=>{e._statusBar._extensionText=t}),e._statusBar.updateText=(()=>e._statusBar._doUpdateText()),e._statusBar._doUpdateText=(()=>{e._statusBar.text=`${e._statusBar._mainText||""} ${e._statusBar._extensionText||""}`}),e._statusBar.stopProgress=(()=>{clearInterval(e._statusBar._progress),delete e._statusBar._progress}),e._statusUpdater=(t=>{e._statusBar.tooltip=t}),e._disposables.add(()=>{e._removeStatusIndicator()}),e._statusBar.hide()}_hideStatusIndicator(){this._statusBar&&(this._statusBar.text="",this._statusBar.tooltip="",this._statusBar.hide()),this._statusUpdater=(()=>{})}_removeStatusIndicator(){this._statusBar&&this._statusBar.dispose(),this._statusUpdater=(()=>{})}deactivate(){this._disposables.dispose()}}s.activate=(e=>{let t=new _;e.subscriptions.push({dispose:()=>t.deactivate()});const s=_._getVersion();if(s.major<=1&&s.minor<18){const e=process.exit,s=function(){t.deactivate(),e.apply(process,arguments)},i=process.exit=function(){s.apply(null,arguments)};process.on("SIGINT",function(){i.apply(null,arguments)}),process.on("SIGTERM",function(){i.apply(null,arguments)}),process.on("exit",function(){i.apply(null,arguments)})}try{let t=r.workspace.getConfiguration();if(t){let s=t.get("quokka.colors",{});s&&Object.keys(s).forEach(t=>{try{if(!t)return;let i=e.asAbsolutePath(n.join("images",t+".svg"));if(!o.existsSync(i))return;const r=('<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="100%" height="100%">'+a.EOL+"  <g>"+a.EOL+'    <rect x="22%" y="22%" width="56%" height="56%" rx="12%" ry="12%" style="fill:#62b455;fill-opacity:1;" />'+a.EOL+"  </g>"+a.EOL+"</svg>").replace(/fill:#.[^;]*/,"fill:"+s[t]);r!==o.readFileSync(i).toString()&&o.writeFileSync(i,r)}catch(e){console.error("Failed to set icon "+t+" type to "+s[t]+". "+e.message)}})}}catch(e){}t.activate(e)})},{"./lib/compositeDisposable":5,"./lib/controller":6,"./lib/startViewPanel":10,fs:void 0,os:void 0,path:void 0,vscode:void 0,"vsls/vscode":void 0}],2:[function(e,t,s){"use strict";var i=e("vscode"),a=e("path");s.activate=function(t){var s=i.workspace.getConfiguration()&&i.workspace.getConfiguration().get("quokka.debug",!1);s?(global.originalRequire=e,t.globalState.update("corePath","../../wallaby/client")):t.globalState.update("corePath","./wallaby/client"),s?e("./out/extension").activate(t):"dist"===a.basename(__dirname)?e("./extension").activate(t):(global.originalRequire=e,e("./dist/index").activate(t))}},{"./extension":1,path:void 0,vscode:void 0}],3:[function(e,t,s){"use strict";var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))(function(a,o){function n(e){try{l(i.next(e))}catch(e){o(e)}}function r(e){try{l(i.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(n,r)}l((i=i.apply(e,t||[])).next())})};Object.defineProperty(s,"__esModule",{value:!0}),s.InteractiveExamples=void 0;const a=e("path"),o=e("fs"),n=e("os"),r=e("https");s.InteractiveExamples=class{constructor(){this.examples=[],this.disposable=void 0,this.disposed=!1,this.configPath=a.join(n.homedir(),".quokka","examples.json"),this.examplesPath=a.join(n.homedir(),".quokka","interactive-examples")}httpGet(e){return i(this,void 0,void 0,function*(){return new Promise((t,s)=>{r.get(e,{headers:{"User-Agent":"Quokka-VSCode-Extension"}},e=>i(this,void 0,void 0,function*(){if(e.statusCode&&e.statusCode>=300&&e.statusCode<400&&e.headers.location)try{const i=yield this.httpGet(e.headers.location);t(i)}catch(e){s(e)}else{let s=Buffer.alloc(0);e.on("data",e=>{s=Buffer.concat([s,e])}),e.on("end",()=>{t(s)})}})).on("error",e=>{s(e)})})})}deleteOldExamplesFolder(){const e=function(t){o.existsSync(t)&&(o.readdirSync(t).forEach(function(s){var i=a.join(t,s);o.lstatSync(i).isDirectory()?e(i):o.unlinkSync(i)}),o.rmdirSync(t))};e(this.examplesPath)}getExampleMetaInformation(){let e=[];const t=this.examplesPath,s=function(i){o.existsSync(i)&&o.readdirSync(i).forEach(function(n){var r=a.join(i,n);if(o.lstatSync(r).isDirectory())s(r);else if("meta.json"===n)try{const s=JSON.parse(o.readFileSync(r).toString());e=[...e,...s.map(e=>(e.folder=a.relative(t,i),e.label=e.title,delete e.title,e))]}catch(e){}})};return s(this.examplesPath),e}initialize(){return i(this,void 0,void 0,function*(){try{if(o.existsSync(this.configPath)){const e=JSON.parse(o.readFileSync(this.configPath).toString());this.examples=e.examples,this.nextCheckTime=e.nextCheckTime,this.sha=e.sha,this.date=e.date}}catch(e){console.error(e)}if(!this.nextCheckTime||(new Date).getTime()>this.nextCheckTime){const t="https://api.github.com/repos/wallabyjs/interactive-examples/commits"+(this.date?"?since"+this.date:"");try{const s=yield this.httpGet(t),i=JSON.parse(s.toString());if(i.length&&this.sha!==i[0].sha){const t=yield this.httpGet("https://github.com/wallabyjs/interactive-examples/archive/master.zip");new(e("adm-zip"))(t).extractAllTo(a.join(n.homedir(),".quokka"),!0),this.deleteOldExamplesFolder(),o.renameSync(a.join(n.homedir(),".quokka","interactive-examples-master"),this.examplesPath),this.examples=this.getExampleMetaInformation(),this.sha=i[0].sha,this.date=i[0].commit.committer.date,this.nextCheckTime=(new Date).getTime()+864e5,o.writeFileSync(this.configPath,JSON.stringify({examples:this.examples,nextCheckTime:this.nextCheckTime,sha:this.sha,date:this.date}))}}catch(e){console.error(e)}}})}getExamples(){return this.examples||[]}getContent(e){try{return o.readFileSync(a.join(this.examplesPath,e.folder,e.fileName)).toString()}catch(e){return""}}getLanguage(e){return"ts"===e.type?"TypeScript":"JavaScript"}dispose(){this.disposable&&this.disposable.dispose(),this.disposed=!0}}},{"adm-zip":void 0,fs:void 0,https:void 0,os:void 0,path:void 0}],4:[function(e,t,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.SalesEvent=void 0;const i=e("path"),a=e("fs"),o=e("os"),n=e("vscode"),r=e("./licenseReader"),l=i.join(o.homedir(),".quokka","state.json");let c=!1;class h{constructor(e,t,s,i){this.disposable=void 0,this.disposed=!1,this.gift=void 0,this.start=e||new Date(Date.UTC(2021,4,6,0,0,0,0)),this.end=t||new Date(Date.UTC(2021,4,20,0,0,0,0)),this.nextCheckTime=void 0,this.buildDate=s||new Date,this.gift=i,this.setup()}setup(){const e=r.LicenseReader.getLicenseDetails(this.buildDate);e&&!e.newInstall&&"activated"!==e.state&&new Date<=this.end&&(this.nextCheckTime=this.getNextCheckTime()||this.start,this.nextCheckTime<this.end&&(this.checkAndShowMessage(),this.disposable=n.window.onDidChangeActiveTextEditor(()=>{this.checkAndShowMessage()})))}saleInProgress(){const e=new Date;return e>this.start&&e<this.end}static checkForTreasure(t,s){if(c)return;c=!0;const i=new Date,a=new Date(2021,6,20),o=new Date(Date.UTC(2021,4,20,0,0,0,0)),l=r.LicenseReader.getLicenseDetails(t);if(i>a||l.installTime>o.getTime())if(!0===h.readStateFile().th)h.updateStateFile({th:i.getTime()});else if(void 0===h.readStateFile().th&&i.getTime()-l.installTime>6048e5){const t=e("https"),a=JSON.stringify({a:"1e04c14350824445b0cb87c6cbc3df17"}),o={hostname:"api.wallabyjs.com",port:443,path:"/c9e5165434144",method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(a)}},r=t.request(o,e=>{let t="";e.on("data",e=>{t+=e}),e.on("end",()=>{if(200===e.statusCode){const e=JSON.parse(t);h.updateStateFile({th:i.getTime(),thc:e.b}),n.window.showInformationMessage("Do you have what it takes to find Quokka's 🎁 special treasure 🎁? Play the game in your editor!",{title:"Start Adventure",gift:!0},{title:"Don't show again",dontShow:!0}).then(e=>{e&&e.gift?(h.updateStateFile({th_start:i.getTime()}),s()):e&&e.dontShow?h.updateStateFile({th_noshow:i.getTime()}):h.updateStateFile({th_ignored:i.getTime()})})}})});r.on("error",e=>{console.error(e)}),r.write(a),r.end()}}checkAndShowMessage(){const e=r.LicenseReader.getLicenseDetails(this.buildDate);if(!e||"activated"!==e.state&&"activating"!==e.state){const t=new Date;!this.disposed&&t>this.start&&t<this.end&&this.nextCheckTime&&t>=this.nextCheckTime&&(this.nextCheckTime=this.setNextCheckTime(),this.showMessageAndHandleUserResponse(e))}else this.setNextCheckTimeToEndDate(),this.dispose()}discountAmount(){const e=[{from:this.start.getTime(),discount:50},{from:this.start.getTime()+6048e5,discount:40}],t=(new Date).getTime(),s=e.sort((e,t)=>t.from-e.from).reduce((e,s)=>e||(t>s.from?s:void 0),void 0);return s?s.discount:0}showMessageAndHandleUserResponse(e){const t="expiring"===e.state,s=[{from:this.start.getTime(),message:(t?"Renew":"Get")+" Quokka.js Pro today with our limited time 50% discount!"},{from:this.start.getTime()+6048e5,message:(t?"Renew":"Get")+" Quokka.js Pro today with our limited time 40% discount!"}],i=(new Date).getTime(),a=s.sort((e,t)=>t.from-e.from).reduce((e,t)=>e||(i>t.from?t:void 0),void 0);if(!a)return;const o=a.message;try{const e=h.readStateFile();e.lastUrlOpen&&!e.th?(h.updateStateFile({th:!0}),n.window.showInformationMessage("We saw you recently looked at Quokka 'PRO' and prepared a short 🎁 treasure hunt 🎁 for you!",{title:"Start Adventure",gift:!0},{title:"Don't show again",dontShow:!0}).then(e=>this.handleUserResponse(e))):n.window.showInformationMessage(o,{title:"Buy License",url:n.Uri.parse("https://wallabyjs.com/store/personal/?referrer=qsp#select-quokka")},{title:"Read More",url:n.Uri.parse("https://quokkajs.com/pro/?referrer=qsp")},{title:"Don't show again",dontShow:!0}).then(e=>this.handleUserResponse(e))}catch(e){}}handleUserResponse(e){e&&(e.dontShow?(this.setNextCheckTimeToEndDate(),this.dispose()):e.url?(this.setLastUrlOpenedTime(),n.commands.executeCommand("vscode.open",e.url)):e.gift&&(this.setNextCheckTimeToEndDate(),this.dispose(),this.gift&&this.gift()))}static updateStateFile(e){let t;try{t=Object.assign(Object.assign({},JSON.parse(a.readFileSync(l).toString())),e)}catch(s){t=Object.assign({},e)}try{a.writeFileSync(l,JSON.stringify(t))}catch(e){}}static readStateFile(){try{return JSON.parse(a.readFileSync(l).toString())}catch(e){return{}}}setNextCheckTimeToEndDate(){h.updateStateFile({nextCheck:this.end})}setLastUrlOpenedTime(){new Date>=this.start&&h.updateStateFile({lastUrlOpen:(new Date).getTime()})}deleteStateConfig(){try{a.existsSync(l)&&a.unlinkSync(l)}catch(e){}}dispose(){this.disposable&&this.disposable.dispose(),this.disposed=!0}setNextCheckTime(){const e=new Date,t=new Date(e.setDate(e.getDate()+1));return h.updateStateFile({nextCheck:t}),t}getNextCheckTime(){try{if(a.existsSync(l)){const e=a.readFileSync(l).toString(),t=JSON.parse(e);return new Date(t.nextCheck)}return}catch(e){this.deleteStateConfig(),this.setNextCheckTimeToEndDate()}}}s.SalesEvent=h},{"./licenseReader":7,fs:void 0,https:void 0,os:void 0,path:void 0,vscode:void 0}],5:[function(e,t,s){"use strict";t.exports=class{constructor(){this._disposables=[]}add(e){e.dispose?this._disposables.push(e):this._disposables.push({dispose:e})}dispose(){this._disposables.forEach(e=>e.dispose())}}},{}],6:[function(e,t,s){"use strict";var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))(function(a,o){function n(e){try{l(i.next(e))}catch(e){o(e)}}function r(e){try{l(i.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(n,r)}l((i=i.apply(e,t||[])).next())})};const a=e("path"),o=e("fs"),n=e("os"),r=e("vscode"),l=e("crypto"),c=global._,h=e("./SalesEvent"),u=e("./InteractiveExamples"),d=global.EventEmitter,_=e("./valueExplorer"),p=e("./recentFilesExplorer"),m=e("./compositeDisposable"),g=e("./outputBuilder"),v=e("./startViewPanel"),f=r.workspace,k=r.window,S=300,w=3500,x="quokka",y="const chest = require('quokka-treasure-chest')",C=["showOutput","createFile","makeQuokkaFromExistingFile","runOnSave","runOnce","toggle","createJavaScriptFile","createTypeScriptFile",,"openStartView","showInstrumentedFile","stopCurrent","stopAll","installMissingPackageToProject","installMissingPackageToQuokka","installQuokkaPlugin","goToLineInQuokkaFile","showLicense","switchToPro","switchToCommunity","selectWorkspaceFolder","addImport","addRequire","showValue","copyValue","copyExpressionPath","copyExpressionData","profile","clearValue","clearFileValues","enableShowValueOnSelection","disableShowValueOnSelection","enableShowSingleInlineValue","disableShowSingleInlineValue","viewRecentFiles","runRecentFile","removeRecentFiles","disableAutoLog","enableAutoLog"],b={javascript:".js",javascriptreact:".js",plaintext:".js",typescript:".ts",typescriptreact:".tsx"},T={".js":"javascriptreact",".jsx":"javascriptreact",".ts":"typescript",".tsx":"typescriptreact"},D={automatic:0,onsave:1,once:2};class P extends d{constructor(e,t,s){super();let i=this;this._state=e,this._context=e.context,this._statusBar=e.statusBar,this._deactivator=e.deactivate,this._Session=e.coreClient.Session,this._utils=e.coreClient.utils,this._buildDate=e.coreClient.buildDate,this._outputDocumentSelector={language:"wallaby-output"},this._setupVersionSpecificComponents(e.version),this._disposables=new m,c.each(C,e=>i._disposables.add(r.commands.registerCommand(`quokka.${e}`,(...t)=>{try{return i[e](...t)}catch(e){console.error(e)}}))),r.commands.executeCommand("setContext","quokka.isLiveShareClient",!1),this._initializeCoverageDecorationTypes(),i._disposables.add(r.workspace.onDidChangeConfiguration(()=>{i._reInitializeCoverageDecorationTypes()})),this._hideAfterContentDecorationType=k.createTextEditorDecorationType({isWholeLine:!0,after:{margin:"0 0 0 10000px !important"}}),this._debugOutputChannel={appendLine:(e,t)=>{console.log("%c "+e,"color: "+("error"===t?"red":"darkgreen"))}},this._activeSessions=[],this._activeSession=null,this._activeLicenseSession=null,r.commands.executeCommand("setContext","quokka.hasActiveSession",!1),i._disposables.add(f.onDidOpenTextDocument(e=>{if(e&&e.uri&&"output"===e.uri.scheme){const t=(e,t)=>{if("wallaby-output"===e.languageId)return;const s=e.lineAt(0);if(s&&s.text&&s.text.length)return~s.text.indexOf("​")||~s.text.indexOf(" ")||~s.text.indexOf(" ");t&&t()};t(e,()=>{const s=f.onDidChangeTextDocument(i=>{i.document===e&&(s.dispose(),t(i.document)&&r.languages.setTextDocumentLanguage(e,"wallaby-output"))})})&&r.languages.setTextDocumentLanguage(e,"wallaby-output")}})),this.outputChannel=this._createOutputChannel(),this.outputChannel.append("​"),i._disposables.add(k.onDidChangeActiveTextEditor(e=>{if(e){var t=this._activeSessions.find(t=>e.document===t.textDocument);if(t)return this._checkAndSyncSession(t),r.commands.executeCommand("setContext","quokka.isActiveEditorRunningQuokka",!0),delete t.activeLineNumber,i._setInlineValuesFileContext(t.hasRemovableMessages),i._setShowValueOnSelectionEnabledContext(t.showValueOnSelection),i._setShowSingleInlineValueEnabledContext(t.showSingleInlineValue),void i._setAutoLogEnabledContext(t.autoLog)}r.commands.executeCommand("setContext","quokka.isActiveEditorRunningQuokka",!1)})),this._setupEnvironment(),this._setupLiveSharing(t,s),r.commands.executeCommand("setContext","quokka.startedAtLeastOnce",!1),this._valueExplorer=new _(this._context),this._recentFilesExplorer=new p(this._quokkaFolder),this._disposables.add(this._recentFilesExplorer),this.on("started",()=>{this._liveShareClientActive()||r.commands.executeCommand("setContext","quokka.startedAtLeastOnce",!0)}),this._previousInlineValuesLineContext=!1,this._previousInlineValuesFileContext=!1,this._automaticRestartActiveTextEditorHandle=void 0,(this._automaticRestart||this._automaticStartRegex)&&k.visibleTextEditors.forEach(e=>{this._checkForAutomaticStart(e)});const a=()=>{this._automaticRestart=r.workspace.getConfiguration().get("quokka.automaticRestart"),this._automaticStartRegex=r.workspace.getConfiguration().get("quokka.automaticStartRegex");try{this._automaticStartRegex&&(this._automaticStartRegex=new RegExp(this._automaticStartRegex))}catch(e){this._automaticStartRegex=""}!this._automaticRestart&&!this._automaticStartRegex||this._automaticRestartActiveTextEditorHandle?this._automaticRestart||this._automaticStartRegex||!this._automaticRestartActiveTextEditorHandle||(this._automaticRestartActiveTextEditorHandle.dispose(),this._automaticRestartActiveTextEditorHandle=void 0):this._automaticRestartActiveTextEditorHandle=k.onDidChangeActiveTextEditor(e=>{this._checkForAutomaticStart(e)})};this._disposables.add(()=>{this._automaticRestartActiveTextEditorHandle&&this._automaticRestartActiveTextEditorHandle.dispose()}),a(),r.workspace.onDidChangeConfiguration&&this._disposables.add(r.workspace.onDidChangeConfiguration(()=>{a()}))}static _hash(e){return l.createHash("md5").update(e).digest("hex").substr(0,16)}_checkForAutomaticStart(e){if(e&&e.document&&"file"===e.document.uri.scheme){const t=a.extname(e.document.uri.fsPath);if(!T[t])return;const s=this._activeSessions.find(t=>t.textDocument===e.document);if(this._automaticStartRegex)try{return void(!s&&this._automaticStartRegex.test(e.document.uri.fsPath)&&this.makeQuokkaFromExistingFile())}catch(e){}this._automaticRestart&&(s&&s.mode===D.automatic?this._context.workspaceState.update("quokka:runningstate:"+P._hash(e.document.uri.fsPath),1):this._context.workspaceState.get("quokka:runningstate:"+P._hash(e.document.uri.fsPath))&&this.makeQuokkaFromExistingFile())}}_createOutputChannel(){return k.createOutputChannel("Quokka")}_showOutputChannel(){this.outputChannel.hide(),this.outputChannel.show(!0)}_initializeCoverageDecorationTypes(){this._coverageDecorationTypes={1:this._createCoverageDecorationType("notCovered","log"),2:this._createCoverageDecorationType("covered","log"),3:this._createCoverageDecorationType("partiallyCovered","log"),4:this._createCoverageDecorationType("errorSource","error"),5:this._createCoverageDecorationType("errorPath","log"),6:this._createCoverageDecorationType("notCovered","system"),7:this._createCoverageDecorationType("covered","system"),8:this._createCoverageDecorationType("partiallyCovered","system"),9:this._createCoverageDecorationType("errorSource","error"),10:this._createCoverageDecorationType("errorPath","system")},this._coverageOverrideState=this._currentCoverageOverrideState()}_currentCoverageOverrideState(){const e=r.workspace.getConfiguration();return JSON.stringify([e.get("quokka.lightTheme.log.decorationAttachmentRenderOptions",{}),e.get("quokka.lightTheme.error.decorationAttachmentRenderOptions",{}),e.get("quokka.darkTheme.log.decorationAttachmentRenderOptions",{}),e.get("quokka.darkTheme.error.decorationAttachmentRenderOptions",{})])}_reInitializeCoverageDecorationTypes(){this._coverageOverrideState!==this._currentCoverageOverrideState()&&(this._activeSessions.forEach(e=>{this._clearDecorations(e)}),this._initializeCoverageDecorationTypes(),this._activeSessions.forEach(e=>{this._updateDocuments(e,e.documentUpdates)}))}_liveShareUrlMatches(e,t){if(e.path.startsWith("/~untitled")&&t.path.startsWith("/~untitled")){const t=e.path.split("/"),s=e.path.split("/");return t[t.length-1]===s[s.length-1]}return 0===e.scheme.localeCompare(t.scheme)&&0===e.path.localeCompare(t.path)}_setupLiveSharing(e,t){return i(this,void 0,void 0,function*(){if(!e)return void this._debugOutputChannel.appendLine("Quokka.js Live Share integration disabled, VSLS not found.");if(this._liveShare={api:e},this._liveShare.server=yield e.shareService(t),this._liveShare.client=yield e.getSharedService(t),!this._liveShare.server||!this._liveShare.client)return this._debugOutputChannel.appendLine('Could not create a shared service. You have to set "liveshare.features" to "experimental" in your user settings in order to use live sharing.'),void delete this._liveShare;const s=()=>c.uniq(this._activeSessions.map(e=>({file:e.liveShareFileName,language:e.textDocument.languageId,originalFile:e.textDocument.uri,fileName:e.fileName,documentUpdates:e.documentUpdates,stats:e.stats,mode:e.mode,headerData:e.headerData,liveConsoleOutput:e.allLiveConsoleOutput,status:e.status}))),a=e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(t.file,e.document.uri));if(t){this._start(e.document,e,t.mode);const s=n(t.file);this.processStarted(s),s.output.setHeaderData(t.headerData),s.headerData=t.headerData,t.documentUpdates[t.file.path]=t.documentUpdates[t.fileName],delete t.documentUpdates[t.fileName],this._updateDocuments(s,t.documentUpdates),s.stats=t.stats,s.status=t.status,this.processStats(s),s.liveConsoleOutput=t.liveConsoleOutput,s.liveConsoleOutput&&s.liveConsoleOutput.length&&this._displayLiveConsoleOutput(s,s.liveConsoleOutput),this._liveShare.activeServerSessions=this._liveShare.activeServerSessions.filter(e=>e!==t)}};this._liveShare.api.onDidChangePeers(e=>i(this,void 0,void 0,function*(){this._liveShareServerActive()&&e.added.length&&(this._liveShare.serverAllowed||this._activeSessions.length&&(k.showWarningMessage("You have not given permission to run Quokka.js in your Live Share Session. All Quokka.js instances have been stopped."),this.stopAll(!0)))})),this._context.subscriptions.push(this._liveShare.server.onDidChangeIsServiceAvailable(e=>i(this,void 0,void 0,function*(){e?(this._activeSessions.forEach(e=>{e.liveShareFileName=this._getLiveShareFileName(e.textDocument.uri)}),this._liveShare.disposable=new m,this._liveShare.disposable.add(()=>delete this._liveShare.serverAllowed),this._liveShare.serverAllowed=!1,this._activeSessions.length&&this._showLiveShareWarningMessage()):(this._liveShare.disposable&&this._liveShare.disposable.dispose(),delete this._liveShare.disposable)}))),this._context.subscriptions.push(this._liveShare.client.onDidChangeIsServiceAvailable(e=>i(this,void 0,void 0,function*(){e?(r.commands.executeCommand("setContext","quokka.isLiveShareClient",!0),r.commands.executeCommand("setContext","quokka.startedAtLeastOnce",!1),this._liveShare.disposable=new m,this._liveShare.disposable.add(()=>delete this._liveShare.activeServerSessions),this._liveShare.disposable.add(k.onDidChangeActiveTextEditor(e=>a(e))),this._liveShare.activeServerSessions=yield this._liveShare.client.request("init",[])):(r.commands.executeCommand("setContext","quokka.isLiveShareClient",!0),this._liveShare.disposable&&this._liveShare.disposable.dispose(),delete this._liveShare.disposable)})));const o=e=>k.visibleTextEditors.find(t=>this._liveShareUrlMatches(e,t.document.uri)),n=e=>this._activeSessions.find(t=>{if(e.path.startsWith("/~untitled")&&t.fileName.startsWith("/~untitled")){const s=e.path.split("/"),i=t.fileName.split("/");return s[s.length-1]===i[i.length-1]}return t.fileName===e.path});this._liveShare.server.onRequest("init",()=>s()),this._liveShare.client.onNotify("busy",e=>{const t=n(e.file);t&&this.processSessionBusy(t)}),this._liveShare.client.onNotify("stopped",e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(t.file,e.file));t&&this._liveShare.activeServerSessions.filter(e=>e!==t);const s=n(e.file);s&&(this._stop(s),this._hideStatusIndicator())}),this._liveShare.client.onNotify("started",e=>{const t=o(e.file);if(!t){return void(this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(t.file,e.file))||this._liveShare.activeServerSessions.push({file:e.file,originalFile:e.originalFile,fileName:e.fileName,documentUpdates:{},stats:void 0,status:void 0,mode:e.data.mode,headerData:null}))}this._start(t.document,t,e.data.mode);const s=n(e.file);this.processStarted(s)}),this._liveShare.client.onNotify("stats",e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(t.file,e.file));t&&(t.stats=e.data,delete t.status,delete t.liveConsoleOutput,delete t.allLiveConsoleOutput);const s=n(e.file);s&&(s.stats=e.data,delete s.status,delete s.liveConsoleOutput,delete s.allLiveConsoleOutput,this.processStats(s))}),this._liveShare.client.onNotify("documentUpdates",e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(e.file,t.file));t&&(t.documentUpdates=e.data);const s=n(e.file);s&&(e.data[s.fileName]=e.data[e.fileName],delete e.data[e.fileName],this._updateDocuments(s,e.data))}),this._liveShare.client.onNotify("consoleOutput",e=>{const t=n(e.file);t&&this._displayLiveConsoleOutput(t,e.data)}),this._liveShare.client.onNotify("configChanged",e=>{const t=this._liveShare.activeServerSessions.find(t=>this._liveShareUrlMatches(e.file,t.file));t&&(t.headerData=e.data);const s=n(e.file);s&&(s.output.setHeaderData(e.data),s.headerData=e.data)})})}_changePro(e){this._pro=e,r.commands.executeCommand("setContext","quokka.isPro",!!e)}_setupEnvironment(){this._quokkaFolder=a.join(n.homedir(),".quokka"),this._wallabyFolder=a.join(n.homedir(),".wallaby"),this._lkp=a.join(this._quokkaFolder,".qlc"),this._ol=a.join(this._wallabyFolder,".ol");try{o.existsSync(this._quokkaFolder)||o.mkdirSync(this._quokkaFolder)}catch(e){}try{o.existsSync(this._wallabyFolder)||o.mkdirSync(this._wallabyFolder)}catch(e){}const e=this._loadQuokkaConfig();this._changePro(!0===e.pro),this._salesEvent=new h.SalesEvent(void 0,void 0,this._buildDate,()=>this._treasureHunt()),this._interactiveExamples=new u.InteractiveExamples,this._interactiveExamples.initialize(),v.setController(this),!0!==e.pro&&!1!==e.pro?v.createOrShow(this._context,{type:"firstInstall"}):v.showWhatsNewIfRequired(this._context)}_quokkaConfigPath(){return a.join(this._quokkaFolder,"config.json")}_loadQuokkaConfig(){const e=this._quokkaConfigPath();let t,s={};try{t=o.readFileSync(e).toString(),s=JSON.parse(t)}catch(e){t&&k.showWarningMessage("Looks like your quokka config.json file has invalid syntax, it should be a valid JSON file.")}return s}_saveQuokkaConfig(e){o.writeFileSync(this._quokkaConfigPath(),JSON.stringify(e))}_getThemableDecorationRenderOptions(e,t){const s=e,i=r.workspace.getConfiguration().get(`quokka.${t}Theme.${s}.decorationAttachmentRenderOptions`,{color:"light"===t?"error"===s?"#c80000":"log"===s?"#0000ff":new r.ThemeColor("editorCodeLens.foreground"):"error"===s?"#fe536a":"log"===s?"rgba(86, 156, 214, 1)":new r.ThemeColor("editorCodeLens.foreground"),margin:"1.2em"}),a={};return Object.keys(i).forEach(e=>{null!==i[e]&&(a[e]=i[e])}),delete a.contentText,delete a.contentIconPath,a}_createCoverageDecorationType(e,t){return k.createTextEditorDecorationType({isWholeLine:!0,rangeBehavior:1,gutterIconPath:this._context.asAbsolutePath(a.join("images",e+".svg")).split("\\").join("/"),light:{after:this._getThemableDecorationRenderOptions(t,"light")},dark:{after:this._getThemableDecorationRenderOptions(t,"dark")}})}addImport(e){k.activeTextEditor&&P._addCode(k.activeTextEditor,`import ${e} from '${e}';\n`)}addRequire(e){k.activeTextEditor&&P._addCode(k.activeTextEditor,`const ${e} = require('${e}');\n`)}static _addCode(e,t){const s=new r.WorkspaceEdit;s.insert(e.document.uri,new r.Position(0,0),t),r.workspace.applyEdit(s)}createFile(){this._runIfAllowed(()=>{const e=["JavaScript","TypeScript",{label:"Recent Files",recent:!0},...this._interactiveExamples.getExamples()];k.showQuickPick(e).then(e=>{if(!e)return;if(e.recent)return this.viewRecentFiles();let t="",s=e;e.label&&(s=this._interactiveExamples.getLanguage(e),t=this._interactiveExamples.getContent(e)),this._createLanguageFile(s,t)})})}profile(){this._activeSession&&k.showQuickPick([{label:"Open profile in Chrome Dev Tools",target:"devtools"},{label:"Open profile in VS Code",target:"editor"}]).then(e=>{e&&e.target&&this._activeSession.runTests({profileRun:e.target,file:this._activeSession.fileName})})}showOutput(){this._activeSession&&this.outputChannel&&this._showOutputChannel()}createJavaScriptFile(){this._runIfAllowed(()=>this._createLanguageFile("JavaScript"))}createTypeScriptFile(){this._runIfAllowed(()=>this._createLanguageFile("TypeScript"))}makeQuokkaFromExistingFile(){this._runIfAllowed(()=>this._runFromExistingFile(D.automatic))}toggle(){const e=k.activeTextEditor;if(!e)return;const t=e.document;t&&(this._activeSessions.find(e=>e.textDocument===t)?this.stopCurrent():this.makeQuokkaFromExistingFile())}runOnSave(){this._pro?this._runIfAllowed(()=>this._runFromExistingFile(D.onsave)):this._showNotification({suggestProEdition:!0,type:"warning",text:"The feature is only available in 'Pro' edition."},this._activeSession)}runOnce(){this._pro?this._runIfAllowed(()=>{const e=k.activeTextEditor;if(!e)return;const t=e.document;if(!t)return;const s=this._activeSessions.find(e=>e.textDocument===t);s&&s.mode===D.once?s.changes.length?this._processDocumentContentChange(s,t,[],!0):s.runTests({file:s.fileName}):this._runFromExistingFile(D.once)}):this._showNotification({suggestProEdition:!0,type:"warning",text:"The feature is only available in 'Pro' edition."},this._activeSession)}stopCurrent(){const e=k.activeTextEditor,t=e&&e.document&&this._activeSessions.find(t=>t.textDocument===e.document)||this._activeSession;t&&this._stop(t,!0)}stopAll(e){this._activeSessions.slice().forEach(t=>this._stop(t,!e))}showInstrumentedFile(){this._activeSession&&this._activeSession.requestInstrumentedFile({path:this._activeSession.fileName},e=>{this._activeSession.output.clearAndRenderHeader(),this._activeSession.output.appendConsoleMessage({text:e,type:"warn"})})}installMissingPackageToProject(){this._installPackage(!0)}installMissingPackageToQuokka(){this._installPackage()}installQuokkaPlugin(e,t){this._installPackage(!1,e,t)}showValue(){this._showValue("show",!0)}copyValue(){this._showValue("copy")}clearValue(){this._clearValues("one")}clearFileValues(){this._clearValues("file")}enableShowValueOnSelection(){this._toggleShowValueOnSelection()}disableShowValueOnSelection(){this._toggleShowValueOnSelection()}enableShowSingleInlineValue(){this._toggleShowSingleInlineValue()}disableShowSingleInlineValue(){this._toggleShowSingleInlineValue()}viewRecentFiles(){return this._recentFilesExplorer.show(this._projectRoot())}runRecentFile(e){const t=a.extname(e.path),s=T[t];s&&(e.runInParentProject?(this._context.globalState.update("quokka:runRecentFile",Object.assign(Object.assign({},e),{runInParentProject:!1})),r.commands.executeCommand("vscode.openFolder",r.Uri.file(e.projectRoot),!0)):e.scratchFile?this._createLanguageFile(s,e.content,e.clone?null:e.id):f.openTextDocument(e.resolvedPath).then(e=>k.showTextDocument(e).then(t=>this._start(e,t,D.automatic))))}removeRecentFiles({files:e,reloadRecentFilesView:t}){return i(this,void 0,void 0,function*(){if(yield this._recentFilesExplorer.removeRecentFiles(e),t)return this._recentFilesExplorer.show(this._projectRoot())})}_toggleAutoLog(){const e=k.activeTextEditor;if(!e)return;if(this._liveShareClientActive())return;const t=this._activeSession;t&&t.textDocument&&e.document===t.textDocument&&(t.toggleAutoLog(),t.autoLog=!t.autoLog,this._setAutoLogEnabledContext(t.autoLog))}disableAutoLog(){this._toggleAutoLog()}enableAutoLog(){this._toggleAutoLog()}_showValue(e,t){const s=k.activeTextEditor;if(!s)return;if(this._liveShareClientActive())return;const i=this._activeSession;if(!i||!i.textDocument||s.document!==i.textDocument)return;const a=s.selection;if(!a||!a.end)return;const o=i.textDocument.getText();i.evaluateExpressionInEditor(i.fileName,o,[a.start.line+1,a.start.character,a.end.line+1,a.end.character],e),t&&this._scheduleOnResultsAvailable(i.fileName,a.end,()=>r.commands.executeCommand("editor.action.showHover"))}_clearValues(e){const t=this._activeSession;if(!t)return;const s={};if(t.messages&&("file"===e||"one"===e)){const i=k.activeTextEditor;if(!i)return;if(s.path=t.fileName,"one"===e){const e=i.selection;if(!e||!e.active)return;const a=i.selection.active.line;if(s.line=a+1,!t.messages[a]||!t.messages[a].removable)return}if("file"===e&&!t.hasRemovableMessages)return;t.removeLogs(s)}}_toggleShowSingleInlineValue(){const e=k.activeTextEditor;if(!e)return;if(this._liveShareClientActive())return;const t=this._activeSession;t&&t.textDocument&&e.document===t.textDocument&&(t.toggleShowSingleInlineValue(),t.showSingleInlineValue=!t.showSingleInlineValue,this._setShowSingleInlineValueEnabledContext(t.showSingleInlineValue))}_toggleShowValueOnSelection(){const e=k.activeTextEditor;if(!e)return;if(this._liveShareClientActive())return;const t=this._activeSession;t&&t.textDocument&&e.document===t.textDocument&&(t.showValueOnSelection=!t.showValueOnSelection,this._setShowValueOnSelectionEnabledContext(t.showValueOnSelection))}_scheduleOnResultsAvailable(e,t,s){this._runOnResultsAvailable={fileName:e,selectionEnd:t,action:s}}_runScheduledActionOnResultsAvailable(){if(!this._runOnResultsAvailable)return;const e=k.activeTextEditor;if(!e)return;const t=this._activeSession;if(!t||!t.textDocument||e.document!==t.textDocument)return;const s=e.selection;if(s&&s.end&&t.fileName===this._runOnResultsAvailable.fileName&&s.end===this._runOnResultsAvailable.selectionEnd)try{this._runOnResultsAvailable.action()}finally{delete this._runOnResultsAvailable}}copyExpressionPath(e){e&&e.copyExpressionPath()}copyExpressionData(e){e&&e.copyExpressionData()}goToLineInQuokkaFile(e){if(!this._activeSession)return;if(!e)return void k.showTextDocument(this._activeSession.textDocument);const t=(e=e.split(","))[0]-1,s=(e[1]||1)-1;k.showTextDocument(this._activeSession.textDocument).then(e=>{const i=new r.Position(t,s);e.revealRange(new r.Range(i,i)),e.selection=new r.Selection(i,i)})}openStartView(){v.createOrShow(this._context)}_installPackage(e,t,s){if(this._activeSession)if(t)this._activeSession.status="progress",this._updateStatus(this._activeSession,"progress"),this._activeSession.runTests({file:this._activeSession.fileName,installPackage:{name:t,plugin:{editConfig:!0,name:s||t}}});else{if(e&&!this._projectRoot())return void k.showWarningMessage("Cannot install a package into project because quokka is running outside of an opened project.");if(!this._pro)return void this._showNotification({suggestProEdition:!0,type:"warning",text:"The feature is only available in 'Pro' edition."},this._activeSession);if(!this._activeSession.stats||!this._activeSession.stats.errors)return void k.showWarningMessage("No missing packages to install.");const t=c.find(this._activeSession.stats.errors,e=>e.missingPackage);if(!t||!t.missingPackage)return void k.showWarningMessage("No missing packages to install.");this._activeSession.status="progress",this._updateStatus(this._activeSession,"progress"),this._activeSession.runTests({file:this._activeSession.fileName,installPackage:{name:t.missingPackage,local:e}})}else k.showWarningMessage("Cannot install a package because quokka is not running.")}_setupVersionSpecificComponents(e){const t=e.major,s=e.minor;t>=1&&s>=11&&(this._outputDocumentSelector.scheme="*"),t>=1&&s>=16&&(this._multiFolderWorkspaces=!0)}_createLanguageFile(e,t,s){return e&&f.openTextDocument({language:e.toLowerCase(),content:t||""}).then(e=>k.showTextDocument(e).then(t=>this._start(e,t,D.automatic,s)))}_stop(e,t){if(t&&"file"===e.textDocument.uri.scheme){this._context.workspaceState.get("quokka:runningstate:"+P._hash(e.textDocument.uri.fsPath))&&this._context.workspaceState.update("quokka:runningstate:"+P._hash(e.textDocument.uri.fsPath),0)}e.disposable&&e.disposable.dispose(),this._activeSessions.splice(this._activeSessions.findIndex(t=>t===e),1),this._hideStatusIndicator(),c.isEmpty(this._activeSessions)&&(this.emit("allSessionStopped"),r.commands.executeCommand("setContext","quokka.hasActiveSession",!1)),this._recentFilesExplorer.reset()}_hideStatusIndicator(){this._statusBar.stopProgress(),this._statusBar.hide()}_relativeNormalizedFilePath(e){return this._utils.normalizePath(a.relative(this._projectRoot(),e))}_runFromExistingFile(e){const t=k.activeTextEditor;if(!t)return;const s=t.document;if(!s)return;const i=this._activeSessions.find(e=>e.textDocument===s);i&&this._stop(i),b[s.languageId]?this._start(s,t,e,this._getFileId(s)):"output"===s.uri.scheme&&"wallaby-output"===s.languageId?this._activeSession&&!this._activeSession.isDisposed()&&this._start(this._activeSession.textDocument,this._activeSession.editors[0],this._activeSession.mode,this._getFileId(this._activeSession.textDocument)):k.showWarningMessage(`Language "${s.languageId}" is not supported`)}_getFileId(e){if(e)try{const t=h.SalesEvent.readStateFile();if((new Date).getTime()-t.th<11232e5&&t.thc)return~e.getText().indexOf(y)?"treasure-hunt-"+t.thc:void 0}catch(e){}}_runIfAllowed(e){!this._liveShareServerActive()||this._liveShare.serverAllowed?e():this._showLiveShareWarningMessage(e)}_showLiveShareWarningMessage(e){k.showWarningMessage("When sharing outside read-only mode, the Quokka.js extension will execute CODE WRITTEN BY OTHERS ON YOUR COMPUTER. Select 'Allow' to continue executing Quokka.js during your Live Share Session.",{title:"Allow",allow:!0},{title:"Deny",allow:!1}).then(t=>{this._liveShare.serverAllowed=!(!t||!t.allow),this._liveShare.serverAllowed?e&&e():this._activeSessions.length&&(k.showInformationMessage("All Quokka.js instances have been stopped."),this.stopAll(!0))})}_liveShareClientActive(){return!!(this._liveShare&&this._liveShare.client&&this._liveShare.client.isServiceAvailable)}_liveShareServerActive(){return!!(this._liveShare&&this._liveShare.server&&this._liveShare.server.isServiceAvailable)}_getLiveShareFileName(e){return"file"===e.scheme?this._liveShare.api.convertLocalUriToShared(e):"untitled"===e.scheme?r.Uri.parse(`vsls:${"/~untitled/"+r.workspace.asRelativePath(e,!1)}`):void 0}_sendToLiveShareClients(e,t,s){this._liveShareServerActive()&&this._liveShare.server.notify(e,{file:t.liveShareFileName,originalFile:t.textDocument.uri,fileName:t.fileName,data:s})}_start(e,t,s,i){this._updateConfigurationFromSettings(),P._checkConfigurationSettings();const o=this._liveShareClientActive(),n=o?{}:new this._Session;o&&(n.isDisposed=(()=>!1),n.stop=(()=>{}));const l=new m;if(this._activeSession&&this._activeSession.output.disableChannel(),l.add(()=>{this._sendToLiveShareClients("stopped",n)}),l.add(()=>{this._valueExplorer.remove(n)}),l.add(()=>{delete this._runOnResultsAvailable}),this._watcher||o||(this._watcher=f.createFileSystemWatcher("**/*.*"),this._disposables.add(this._watcher)),o||(l.add(r.languages.registerHoverProvider(e.languageId,{provideHover:(t,s)=>{if(t!==e||c.isEmpty(n.errors))return;const i=(n.errors[s.line]||{}).hover;return i?new r.Hover(i.value):void 0}})),l.add(r.languages.registerCodeActionsProvider(e.languageId,{provideCodeActions:(t,s)=>{if(t!==e||c.isEmpty(n.errors))return;const i=(n.errors[s.start.line]||{}).commands;return i||void 0}}))),n.mode=s,n.disposable=l,n.textDocument=e,n.changes=[],n.fileName=x+b[e.languageId],n.fileId=i,n.documentUpdates={},s===D.automatic&&!o){const e=e=>{n.textDocument.uri.path!==e.path&&"progress"!==n.status&&n.runTests({file:n.fileName,externalFileChange:!0})};l.add(this._watcher.onDidCreate(e)),l.add(this._watcher.onDidChange(e)),l.add(this._watcher.onDidDelete(e))}let h;if("file"===e.uri.scheme){const t=e.uri.path.split("/");h=t[t.length-1]}else if("vsls"===e.uri.scheme){const t=e.uri.path.split("/");h=t[t.length-1]}else h=e.uri.path+b[e.languageId];if(n.id=h,"file"===e.uri.scheme)if(this._projectRoot(e.uri.fsPath)){const t=this._relativeNormalizedFilePath(e.uri.fsPath);t&&(n.fileName=t)}else n.localRoot=a.dirname(e.uri.fsPath),n.fileName=a.basename(e.uri.fsPath);else void 0===n.fileId&&this._recentFilesExplorer.findRecentScratchFileIdByContent(e.getText()).then(e=>{n.fileId=e});this._liveShareServerActive()&&(n.liveShareFileName=this._getLiveShareFileName(e.uri)),"vsls"===e.uri.scheme&&o&&(n.fileName=e.uri.path),n.editors=[t],n.liveConsoleOutput=[],n.allLiveConsoleOutput=[],this._activeSessions.push(n),r.commands.executeCommand("setContext","quokka.hasActiveSession",!0),l.add(f.onDidCloseTextDocument(t=>{e===t&&this._stop(n)})),l.add(f.onDidChangeTextDocument(t=>{e===t.document&&(n.mode===D.automatic?this._processDocumentContentChange(n,t.document,t.contentChanges,!0):(this._hideStatusIndicator(),this._clearDecorations(n),this._processDocumentContentChange(n,t.document,t.contentChanges,!1)))})),l.add(f.onDidSaveTextDocument(t=>{e===t&&n.mode===D.onsave&&this._processDocumentContentChange(n,t,[],!0)})),l.add(k.onDidChangeActiveTextEditor(t=>{const s=n.editors.includes(t);n.editors=n.editors.filter(e=>k.visibleTextEditors.includes(e)),k.visibleTextEditors.filter(t=>t.document===e).forEach(e=>{n.editors.includes(e)||(n.editors.push(e),this._updateDocuments(n,n.documentUpdates))}),s&&this._updateDocuments(n,n.documentUpdates)})),l.add(k.onDidChangeTextEditorSelection(t=>{if(t&&t.selections&&t.selections.length&&t.textEditor.document===e){const e=t.selections[0];if(n.activeLineNumber!==e.active.line){n.activeLineNumber=e.active.line;const t=n.activeLineNumber;this._setInlineValuesLineContext(n.messages&&n.messages[t]&&n.messages[t].removable)}this._pro&&n.showValueOnSelection&&n.mode===D.automatic&&(e.start.line===e.end.line&&e.start.character!==e.end.character||e.start.line===e.end.line-1&&0===e.end.character)&&this._showValue("show")}}));const u=c.bind(this._absoluteFilePath,this);n.output=new g(this.outputChannel,n.fileName,u,this._state.coreClient.dmp,n.disposable,this._outputDocumentSelector,!!this._projectRoot(),this._liveShareClientActive(),n.id,this._compactMessageOutput),this._colorizeOutput?n.output.useMarkup():n.output.disableMarkup(),o||(n.start({localRoot:this._projectRoot()||n.localRoot,quokkaFolder:this._quokkaFolder,client:"VSCode",cv:r.version,fileName:n.fileName,fileId:n.fileId,editorTypeScript:a.join(process.mainModule.filename,"../../extensions/node_modules/typescript")}),n.on("notification",e=>this._showNotification(e,n)),n.on("busy",()=>{this._sendToLiveShareClients("busy",n),this.processSessionBusy(n)}),n.on("copyToClipboard",e=>{r.env.clipboard.writeText(e.data)}),n.on("stopped",e=>{this._sendToLiveShareClients("stopped",n),this._stop(n),this._hideStatusIndicator(),e.deactivate&&(this.stopAll(!0),this._forceDeactivate())}),n.on("started",()=>{this._sendToLiveShareClients("started",n,{mode:n.mode}),this.processStarted(n)}),n.on("stats",e=>{this._sendToLiveShareClients("stats",n,e),n.stats=e,delete n.status,delete n.liveConsoleOutput,delete n.allLiveConsoleOutput,this.processStats(n),e&&e.messages&&(this._valueExplorer.update(n,e.messages),this._runScheduledActionOnResultsAvailable())}),n.on("live",()=>{n.fileChangedInEditor(n.fileName,n.textDocument.getText(),void 0,void 0,n.fileId),n.fileOpenedInEditor(n.fileName),n.editors.includes(k.activeTextEditor)&&r.commands.executeCommand("setContext","quokka.isActiveEditorRunningQuokka",!0)}),n.on("configChanged",e=>{this._changePro(e&&e.pro),r.commands.executeCommand("setContext","quokka.isProfilingEnabled",!!e.profiling),n.output.setHeaderData(e),n.headerData=e,n.showValueOnSelection=!1!==e.showValueOnSelection,n.showSingleInlineValue=!1!==e.showSingleInlineValue,n.autoLog=!0===e.autoLog,this._setShowValueOnSelectionEnabledContext(n.showValueOnSelection),this._setShowSingleInlineValueEnabledContext(n.showSingleInlineValue),this._setAutoLogEnabledContext(n.autoLog),this._sendToLiveShareClients("configChanged",n,e)}),n.on("documentUpdates",e=>{this._updateDocuments(n,e),this._sendToLiveShareClients("documentUpdates",n,e)}),n.on("consoleError",e=>{e&&e.split("\n").forEach(e=>e&&this._debugOutputChannel.appendLine(`[Error] #${n.id} ${e}`,"error")),n.emit("stats",e)}),n.on("consoleLog",e=>{e&&e.split("\n").forEach(e=>e&&this._debugOutputChannel.appendLine(`[Info]  #${n.id} ${e}`))}),n.on("consoleOutput",e=>{this._sendToLiveShareClients("consoleOutput",n,e),this._displayLiveConsoleOutput(n,e)}),n.on("navigationRequested",e=>this._navigate(e.file,e.loc)),n.on("profileAvailable",e=>{r.commands.executeCommand("vscode.open",r.Uri.file(e.path),-2)})),n.status="progress",this._updateStatus(n,"progress"),l.add(()=>{n.output.dispose(),n.stop(),this._clearDecorations(n),delete n.editors,delete n.disposable,delete n.output,n===this._activeSession&&delete this._activeSession,P._clearIdleSessionTimeout(n),this._debugOutputChannel.appendLine(`[Info]  #${n.id} Quokka.js stopped`),this.outputChannel.clear(),this.outputChannel.append("​")}),this.emit("started");const d=this._context.workspaceState.get("quokka:runningstate:"+P._hash(n.textDocument.uri.fsPath));this._automaticRestart&&n.mode===D.automatic?this._context.workspaceState.update("quokka:runningstate:"+P._hash(n.textDocument.uri.fsPath),1):d&&this._context.workspaceState.update("quokka:runningstate:"+P._hash(n.textDocument.uri.fsPath),0)}processStats(e){e.stats&&(P._outputResults(e.output,e.stats),this._processErrors(e)),this._updateStatus(e),P._sessionIsActive(e)}processStarted(e){this._debugOutputChannel.appendLine(`[Info]  #${e.id} Quokka.js started`),r.workspace.getConfiguration().get("quokka.showOutputOnStart",!0)&&(this._liveShareClientActive()?this._liveShare.outputChannelShown||(this._liveShare.outputChannelShown=!0,this._showOutputChannel()):this._showOutputChannel()),this._liveShareClientActive()&&k.showTextDocument(e.textDocument,e.editors&&(e.editors.length||void 0)&&e.editors[0]&&e.editors[0].viewColumn)}processSessionBusy(e){clearTimeout(this._statusUpdateTimeout),this._statusUpdateTimeout=setTimeout(()=>{e.status="progress",this._updateStatus(e,"progress")},S),e.liveConsoleOutput=[],e.allLiveConsoleOutput=[],this._scheduleSessionIdleTimeout(e)}_forceDeactivate(){this._deactivator(),c.each(C,e=>r.commands.registerCommand(`quokka.${e}`,()=>k.showWarningMessage("Please restart VS Code for a new trial session of Quokka.js 'Pro'.")))}_showNotification(e,t){const s=[];if(~e.text.indexOf("expire")&&"warning"===e.type&&this._suppressExpirationNotifications)return;const i=e=>e&&e.url&&r.commands.executeCommand("vscode.open",e.url);if(e.invalidVersion||"expiredLicense"===e.id){e.text="You are not licensed to use Quokka PRO features for this version of Quokka. As your 12 months of free Quokka updates have expired, this is likely a result of VS Code updating your Quokka extension automatically.",s.push({title:"Renew",url:r.Uri.parse(v.getLicenseDetails().renewUrl),command:i}),s.push({title:"Activate",command:"quokka.showLicense"}),s.push({title:"Switch to 'Community'",command:"quokka.switchToCommunity"});const t=new Date(e.expiryDate),a="https://quokkajs.com/docs/previous.html?expirydate="+t.getUTCFullYear()+"-"+(t.getUTCMonth()+1)+"-"+t.getUTCDate();s.push({title:"Help / Downgrade",url:r.Uri.parse(a),command:i})}else e.expiringSoon?e.trial?(e.text="Your Quokka trial period is almost over and finishes on "+e.expirationDateStringFormatted+". If you would like to continue to use Quokka 'PRO', please visit our website to purchase a license.",s.push({title:"Purchase",url:r.Uri.parse(v.getLicenseDetails().purchaseUrl),command:i}),s.push({title:"Activate",command:"quokka.showLicense"})):(e.text="Your Quokka license free upgrades period expires on "+e.expirationDateStringFormatted+". If you would like to work with the latest version of Quokka and future versions released within the next 12 months, please visit our website to upgrade your license.",s.push({title:"Renew",url:r.Uri.parse(v.getLicenseDetails().renewUrl),command:i}),s.push({title:"Activate",command:"quokka.showLicense"}),s.push({title:"What's New",command:()=>{v.createOrShow(this._context,{type:"showAllWhatsNew"})}})):e.suggestProEdition?(s.push({title:"Switch to 'Pro'",command:()=>{this._switchEdition(!0,t),v.createOrShow(this._context,{type:"goToLicenseSection"})}}),s.push({title:"More info",url:r.Uri.parse("https://quokkajs.com/pro?referrer=VSCode"),command:i})):(~e.text.indexOf("continue-trial-link")?s.push({title:"Continue Trial",command:()=>t&&!t.isDisposed()&&t.continueTrial()}):~e.text.indexOf("extended-trial-license-link")&&s.push({title:"Request License",command:"_requestTrialLicense"}),~e.text.indexOf("activate-link")&&s.push({title:"Activate",command:"quokka.showLicense"}),~e.text.indexOf("purchase")&&(s.push({title:"Purchase",url:r.Uri.parse("https://quokkajs.com/pro?referrer=VSCode"),command:i}),s.push({title:"Switch to 'Community'",command:"quokka.switchToCommunity"})));e.allowMuting&&s.push({title:"Don't show again",command:()=>t&&!t.isDisposed()&&t.muteNotification(e.id)}),e.text=e.text.replace(/<br\/><br\/>/g," ").replace(/<br\/>/g," ").replace(/<[^>]*>/g,"");const a=[e.text].concat(s);k["show"+e.type.charAt(0).toUpperCase()+e.type.substr(1)+("info"===e.type?"rmation":"")+"Message"].apply(k,a).then(this._executeCommand),0===e.text.indexOf("Can not start node.js process")&&k.showInformationMessage('You may use the "node" setting to configure the location of node.',{title:"More info",url:r.Uri.parse("https://quokkajs.com/docs/configuration.html#nodejs-version")}).then(e=>{e&&e.url&&r.commands.executeCommand("vscode.open",e.url)})}_checkAndSyncSession(e){return!!k.visibleTextEditors.find(t=>t.document===e.textDocument)&&(e!==this._activeSession&&(this._activeSession&&this._activeSession.output.disableChannel(),this._activeSession=e,e.output.enableChannel(),e.output.render(),this.processStats(e)),!0)}_requestTrialLicense(){v.createOrShow(this._context,{type:"trial"})}showLicense(){v.createOrShow(this._context,{type:"activate"})}processLicenseChange(e,t){if(c.isUndefined(e))return;let s="";try{s=JSON.parse(Buffer.from(o.readFileSync(this._ol).toString(),"base64").toString())}catch(e){s={}}let i="";try{i=o.readFileSync(this._lkp).toString()}catch(e){}if(/^[a-zA-Z0-9_+&*-]+(?:\.[a-zA-Z0-9_+&*-]+)*@(?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,63}$/.test(e)){try{s.quokkaEmail=e.trim(),s.lastUpdate=(new Date).getTime(),o.writeFileSync(this._ol,Buffer.from(JSON.stringify(s)).toString("base64")),this._activeLicenseSession&&(this._activeLicenseSession.stop(),this._activeLicenseSession=null);const i=new this._Session;i.stop=(()=>{i===this._activeLicenseSession&&(this._activeLicenseSession=null)}),i.start({localRoot:this._projectRoot(),quokkaFolder:this._quokkaFolder,client:"VSCode",cv:r.version,fileName:"quokka.js",editorTypeScript:a.join(process.mainModule.filename,"../../extensions/node_modules/typescript"),ol:!0}),i.on("notification",e=>{t({type:"notification",text:e})}),this._activeLicenseSession=i,this.switchToPro()}catch(e){t({type:"error",text:"Unable to save email activation request: "+e.message,items:["Dismiss"]})}return}try{o.unlinkSync(this._ol)}catch(e){}const l=i,h=e||"",u=!!this._parseLicenseKey(l),d=this._parseLicenseKey(h),_=!!d;let p=!1;if(_||!h&&u)try{if(o.writeFileSync(this._lkp,h),d.isBundle){const e=a.join(n.homedir(),".wallaby"),t=a.join(e,"key.lic");o.existsSync(e)||o.mkdirSync(e),o.writeFileSync(t,h)}p=_}catch(e){t({type:"error",text:"Unable to save license key: "+e.message,items:["Dismiss"]}),p=!1}else t({type:"error",text:"The entered license key is not a valid Quokka.js 'Pro' license key.",items:[]});p&&(t({type:"info",text:`Quokka.js 'Pro' is licensed to: ${d.licensee}. Upgrades and updates until: ${d.expiration}.`,items:[]}),this.switchToPro())}_parseLicenseKey(e){if(c.isString(e))try{let t=this._utils.parseKey(e);if(t.licenseeName&&t.expirationDateString&&~t.licensedProduct.indexOf("Quokka"))return{licensee:t.licenseeName,isBundle:0===t.licensedProduct.indexOf("Wallaby.js + Quokka.js"),expiration:t.expirationDateStringFormatted||t.expirationDateString}}catch(e){return}}switchToCommunity(){this._switchEdition(!1,this._activeSession)}switchToPro(){this._switchEdition(!0,this._activeSession)}_treasureHunt(){const e="treasure-hunt-"+h.SalesEvent.readStateFile().thc;this._createLanguageFile("JavaScript",`/*_____________________________________________________________________________\n__________  DO YOU HAVE WHAT IT TAKES TO FIND QUOKKA PRO TREASURE?  ___________\n          |                   |                  |                     |\n _________|________________.=""_;=.______________|_____________________|_______\n|                   |  ,-"_,=""     \`"=.|                  |\n|___________________|__"=._o\`"-._        \`"=.______________|___________________\n          |                \`"=._o\`"=._      _\`"=._                     |\n _________|_____________________:=._o "=._."_.-="'"=.__________________|_______\n|                   |    __.--" , ; \`"=._o." ,-"""-._ ".   |\n|___________________|_._"  ,. .\` \` \`\` ,  \`"-._"-._   ". '__|___________________\n          |           |o\`"=._\` , "\` \`; .". ,  "-._"-._; ;              |\n _________|___________| ;\`-.o\`"=._; ." \` '\`."\\\` . "-._ /_______________|_______\n|                   | |o;    \`"-.o\`"=._\`\`  '\` " ,__.--o;   |\n|___________________|_| ;     (#) \`-.o \`"=.\`_.--"_o.-; ;___|___________________\n____/______/______/___|o;._    "      \`".o|o_.--"    ;o;____/______/______/____\n/______/______/______/_"=._o--._        ; | ;        ; ;/______/______/______/_\n____/______/______/______/__"=._o--._   ;o|o;     _._;o;____/______/______/____\n/______/______/______/______/____"=._o._; | ;_.--"o.--"_/______/______/______/_\n____/______/______/______/______/_____"=.o|o_.--""___/______/______/______/____\n/______/______/______/______/______/______/______/______/______/______/______*/\n\n// Welcome to Quokka Pro Treasure Hunt! It only takes a minute to complete,\n// and a very special surprise awaits those who can do it.\n\n// If you get stuck, here's some pointers:\n// Quick Module Install:  https://quokkajs.com/docs/#modules\n// Live Comments:         https://quokkajs.com/docs/#comments\n// Value Explorer:        https://quokkajs.com/docs/#value-explorer\n\n// Good luck and enjoy!\n\n// 1) Fix the error below and install the missing module for the current quokka\n//    file using the link in the Quokka output or in the line hover message\n//    or quick action.\n\n${y}\n\n// 2) So, you have found an old chest, there may be some treasure inside it.\n//    You need to pass a correct string key to the "open" function.\n//    The "open" function returns a clue about how to find the key.\n//    Add Quokka live comment at the end of the line to see the returned value:\n//    chest.open('paste_key_here') //?\n\nchest.open('paste_key_here')\n`,e)}_switchEdition(e,t){const s=this._loadQuokkaConfig();if(s.pro=e,this._changePro(e),this._saveQuokkaConfig(s),!this._liveShareClientActive()&&t&&!t.isDisposed()){const e=t.textDocument,s=t.editors[0];this.stopAll(!0),t.mode!==D.automatic&&t.mode!==D.onsave||this._start(e,s,t.mode)}}_processErrors(e){this._liveShareClientActive()||e.stats.errors&&(e.errors={},P._addError(e,P._createLineDataObject(e,e=>e.missingPackage,e=>[{title:`Install "${e.missingPackage}" package for the current quokka file`,command:"installMissingPackageToQuokka"},this._projectRoot()&&{title:`Install "${e.missingPackage}" package into the project`,command:"installMissingPackageToProject"}])),P._addError(e,P._createLineDataObject(e,e=>e.missingBrowserGlobal,e=>[{title:`"${e.missingBrowserGlobal}" looks like a browser global`},{title:"Install and use quokka browser plugin",command:"installQuokkaPlugin",args:["jsdom","jsdom-quokka-plugin"]}])),P._addError(e,P._createLineDataObject(e,e=>e.undefinedName,e=>[{title:`Add "import ${e.undefinedName} from '${e.undefinedName}';"`,command:"addImport",arg:e.undefinedName},{title:`Add "const ${e.undefinedName} = require('${e.undefinedName}');"`,command:"addRequire",arg:e.undefinedName}])))}static _addError(e,t){t&&(e.errors[t.line]=t)}static _createHoverObject(e){return e.filter(e=>!!e).map(e=>e.command?`\n[${e.title}](${encodeURI(`command:quokka.${e.command}${e.arg?"?"+JSON.stringify(e.arg):""}`)})`:e.title).join("\n")}static _createCommands(e){return e.filter(e=>e&&e.command).map(e=>({title:e.title,command:`quokka.${e.command}`,arguments:e.args?e.args:e.arg?[e.arg]:void 0}))}static _createLineDataObject(e,t,s){const i=e.stats.errors.find(t),a=i&&i.stack||[];if(a.reverse(),a.length){const t=c.find(a,t=>t.file===e.fileName);if(t&&t.loc&&t.loc.split){const e=s(i);let a=P._createHoverObject(e);return r.MarkdownString&&((a=new r.MarkdownString(a)).isTrusted=!0),{line:parseInt(t.loc.split(":")[0],10)-1,hover:{value:a},commands:P._createCommands(e)}}}}static _checkConfigurationSettings(){try{let e=r.workspace.getConfiguration();if(e){e.get("quokka.suppressGlyphMarginNotifications",!1)||e.get("editor.glyphMargin",!0)||k.showWarningMessage("Quokka.js will not display coverage indicators in the gutter because the `editor.glyphMargin` setting is set to `false`. You can hide this message by setting `quokka.suppressGlyphMarginNotifications` to `false`.")}}catch(e){}}_updateConfigurationFromSettings(){let e="",t=!1;try{var s=this._loadQuokkaConfig();e=s.node,s.useWsl&&(t=s.useWsl)}catch(e){}try{process.env.WALLABY_USE_WSL=t;const s=r.workspace.getConfiguration();if(s){this._suppressExpirationNotifications=s.get("quokka.suppressExpirationNotifications",!1),this._colorizeOutput=s.get("quokka.colorizeOutput",!0),this._compactMessageOutput=s.get("quokka.compactMessageOutput",!1);const t=s.get("quokka.node",e);t?process.env.WALLABY_NODE=t:delete process.env.WALLABY_NODE}}catch(e){}}activate(){let e;this._onceDocumentStopsChanging=c.debounce(c.bind(this._onceDocumentStopsChanging,this),100),P._outputResults=c.debounce(c.bind(P._outputResults,this),100),this._statusBar.updateText=c.debounce(c.bind(this._statusBar.updateText,this._statusBar),200),this._executeCommand=c.bind(this._execute,this),this._statusBar.command="quokka.showOutput",this._disposables.add(()=>{if(this._statusBar&&this._statusBar.hide(),this._activeLicenseSession)try{this._activeLicenseSession.stop(),this._activeLicenseSession=null}catch(e){}this._activeSessions.forEach(e=>e.disposable.dispose()),this._activeSessions.length=0,r.commands.executeCommand("setContext","quokka.hasActiveSession",!1)});const t=()=>{try{const s=this._context.globalState.get("quokka:runRecentFile");s&&p.pathToMetadataKey(s.projectRoot)===p.pathToMetadataKey(this._projectRoot())&&(this._context.globalState.update("quokka:runRecentFile",void 0),this.runRecentFile(s))}finally{e=setTimeout(t,1e3)}};t(),this._disposables.add(()=>{clearTimeout(e)})}_projectRoot(e){if(e&&this._multiFolderWorkspaces&&f.workspaceFolders&&f.workspaceFolders.length){const t=c.find(f.workspaceFolders,t=>~e.indexOf(t.uri.fsPath+a.sep));if(t)return this._currectProjectRoot=t.uri.fsPath,this._currectProjectRoot}if(this._currectProjectRoot)if(this._multiFolderWorkspaces&&f.workspaceFolders){const e=c.find(f.workspaceFolders,e=>this._currectProjectRoot===e.uri.fsPath);if(e)return e.uri.fsPath}else if(f.rootPath&&this._currectProjectRoot===f.rootPath)return f.rootPath;return this._multiFolderWorkspaces&&f.workspaceFolders?f.workspaceFolders.length?f.workspaceFolders[0].uri.fsPath:void 0:f.rootPath||""}selectWorkspaceFolder(){this._multiFolderWorkspaces&&f.workspaceFolders&&f.workspaceFolders.length>1&&k.showWorkspaceFolderPick&&k.showWorkspaceFolderPick().then(e=>{e&&(this._currectProjectRoot=e.uri.fsPath)})}deactivate(){this._disposables.dispose()}static _sessionIsActive(e){P._clearIdleSessionTimeout(e)}_sessionIsIdle(e){this._clearDecorations(e),delete e.stats,e.liveConsoleOutput&&!e.liveConsoleOutput.started&&e.output.clearAndRenderHeader()}static _clearIdleSessionTimeout(e){e.idleTimeout&&(clearTimeout(e.idleTimeout),delete e.idleTimeout)}_clearDecorations(e){e.editors.forEach(e=>{c.each(this._coverageDecorationTypes,t=>e.setDecorations(t,[])),e.setDecorations(this._hideAfterContentDecorationType,[])})}_scheduleSessionIdleTimeout(e){P._clearIdleSessionTimeout(e),e.idleTimeout=setTimeout(()=>this._sessionIsIdle(e),w)}_displayLiveConsoleOutput(e,t){if(!e.liveConsoleOutput)return;const s=e.liveConsoleOutput.started;e.liveConsoleOutput=e.liveConsoleOutput.concat(t),e.liveConsoleOutput.started=s,e.liveConsoleOutput.started?e.displayLiveConsoleOutputTimeout||this._displayPendingLiveConsoleOutput(e):(e.liveConsoleOutput.started=!0,e.displayLiveConsoleOutputTimeout=setTimeout(()=>{delete e.displayLiveConsoleOutputTimeout,e.liveConsoleOutput&&e.liveConsoleOutput.length&&(e.output.clearAndRenderHeader(),this._displayPendingLiveConsoleOutput(e))},150))}_displayPendingLiveConsoleOutput(e){e.allLiveConsoleOutput=e.allLiveConsoleOutput.concat(e.liveConsoleOutput),e.liveConsoleOutput.forEach(t=>e.output.appendConsoleMessage(t)),e.liveConsoleOutput.length=0}_execute(e){if(e&&e.command)return"function"==typeof e.command?e.command(e):~e.command.indexOf("quokka.")?r.commands.executeCommand(e.command):this[e.command]()}_processDocumentContentChange(e,t,s,i){e.isDisposed()||t&&t.uri&&t.uri.scheme&&"file"!==t.uri.scheme&&"untitled"!==t.uri.scheme&&"vsls"!==t.uri.scheme||(e.changes=e.changes.concat(s),this._hideMessagesForChangedRanges(e.changes),i&&this._onceDocumentStopsChanging(e,t))}_onceDocumentStopsChanging(e,t){!e.isDisposed()&&e.changes.length&&(this._liveShareClientActive()||(clearTimeout(this._statusUpdateTimeout),this._statusUpdateTimeout=setTimeout(()=>{e.status="progress",this._updateStatus(e,"progress")},S),e.fileChangedInEditor(e.fileName,t.getText(),{start:c.chain(e.changes).map(e=>e.range.start.line).min().value()+1,end:c.chain(e.changes).map(e=>e.range.end.line).max().value()+1},!1,e.fileId),e.changes=[]))}_updateStatus(e){if(e.isDisposed())return;let t,s=e.status;clearTimeout(this._statusUpdateTimeout),s||(s=c.isString(e.stats)?"failing":e.stats?e.stats.errors.length?"failing":"passing":"failing",t=e.stats&&e.stats.time),s&&("progress"===s?this._statusBar.displayProgress():(this._statusBar.stopProgress(),this._statusBar.setMainText(("failing"===s?"✗":"✔")+(t?` ${t}ms`:"")),this._statusBar.updateText()),this._statusBar.show()),this._activeSession=e}_updateStatusExtension(e){this._statusBar.setExtensionText(e),this._statusBar.updateText()}_removeStatus(){this._statusBar.hide()}_updateDocuments(e,t){if(e.isDisposed())return;if(e.changes.length&&!this._liveShareClientActive())return;e.documentUpdates=t;const s=k.activeTextEditor&&k.activeTextEditor.selection;let i=void 0,a=!1;s&&s.active&&(i=s.active.line),c.each(k.visibleTextEditors,s=>{if(!s)return;const o=s.document;if(o!==e.textDocument)return;e.hasRemovableMessages=!1,e.messages=Object.create(null);const n=t[e.fileName];if(!n||!n.lines)return;const l={1:[],2:[],3:[],4:[],5:[],6:[],7:[],8:[],9:[],10:[]};c.each(n.lines,t=>{const s=t.num-1;if(s<0||s>=o.lineCount)return;const n=o.lineAt(s);if(!n)return;const c=t.meta||{},h={range:new r.Range(n.lineNumber,n.firstNonWhitespaceCharacterIndex,n.lineNumber,n.range.end.character)},u=t.err||t.log,d=t.longLog||u;if(d&&(h.hoverMessage=r.MarkdownString?new r.MarkdownString("```\n"+d+"\n```"):{value:d}),l[t.state+(t.meta&&t.meta.system?5:0)].push(h),u&&(h.renderOptions={after:{contentText:u}},t.log)){const t=c.log&&c.log.removable;e.messages[n.lineNumber]={removable:t},t&&(e.hasRemovableMessages=!0,n.lineNumber===i&&(a=!0))}}),c.each(l,(e,t)=>s.setDecorations(this._coverageDecorationTypes[t],e)),this._scheduleHiddenMessagesDisplay()}),k.activeTextEditor&&e.textDocument===k.activeTextEditor.document&&(this._setInlineValuesLineContext(a),this._setInlineValuesFileContext(e.hasRemovableMessages))}_hideMessagesForChangedRanges(e){clearTimeout(this._displayHiddenMessagesTimeout),this._messagesHiddenAt=+new Date,k.activeTextEditor&&k.activeTextEditor.setDecorations(this._hideAfterContentDecorationType,e.map(e=>({range:new r.Range(e.range.start.line,0,e.range.end.line,Number.MAX_SAFE_INTEGER)})))}_scheduleHiddenMessagesDisplay(){let e=this;clearTimeout(this._displayHiddenMessagesTimeout);let t=this._messagesHiddenAt?+new Date-this._messagesHiddenAt:400;this._displayHiddenMessagesTimeout=setTimeout(()=>{try{c.each(k.visibleTextEditors,t=>t&&t.setDecorations(e._hideAfterContentDecorationType,[]))}catch(e){}},Math.max(0,500-t))}_navigate(e,t){if(!e)return;if(this._activeSession&&e===this._activeSession.fileName)return this.goToLineInQuokkaFile(t);let s,i,a=this._absoluteFilePath(e);c.isNumber(t)?s=t:c.isArray(t)?(s=t[0],i=t[1]):c.isString(t)&&(t=t.split(":"),s=t[0]&&parseInt(t[0],10),i=t[1]&&parseInt(t[1],10)),c.isNumber(s)?s-=1:s=0,c.isNumber(i)||(i=0),f.openTextDocument(a).then(e=>k.showTextDocument(e)).then(e=>{let t=new r.Position(s,i);e.revealRange(new r.Range(t,t)),e.selection=new r.Selection(t,t)})}_absoluteFilePath(e){const t=this._activeSession&&this._activeSession.localRoot;return a.resolve(this._projectRoot()||t,e)}_setInlineValuesLineContext(e){e=!!e,this._previousInlineValuesLineContext!==e&&(this._previousInlineValuesLineContext=e,this._setContext("quokka.lineHasRemovableInlineValues",e))}_setInlineValuesFileContext(e){e=!!e,this._previousInlineValuesFileContext!==e&&(this._previousInlineValuesFileContext=e,this._setContext("quokka.fileHasRemovableInlineValues",e))}_setShowSingleInlineValueEnabledContext(e){this._setContext("quokka.showSingleInlineValueEnabled",e)}_setShowValueOnSelectionEnabledContext(e){this._setContext("quokka.showValueOnSelectionEnabled",e)}_setAutoLogEnabledContext(e){this._setContext("quokka.autoLogEnabled",e)}_setContext(e,t){r.commands.executeCommand("setContext",e,t)}static _outputResults(e,t,s){let i,a=e.lines();e.build(t);let o=e.lines();if(!(i=s||o.length!==a.length))for(let t=0,s=o.length;t<s;t++)if(e.areDifferent(o[t],a[t])){i=!0;break}i&&e.render()}}t.exports=P},{"./InteractiveExamples":3,"./SalesEvent":4,"./compositeDisposable":5,"./outputBuilder":8,"./recentFilesExplorer":9,"./startViewPanel":10,"./valueExplorer":11,crypto:void 0,fs:void 0,os:void 0,path:void 0,vscode:void 0}],7:[function(e,t,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.LicenseReader=void 0;const i=e("fs"),a=e("os"),o=e("path");class n{static getLicenseDetails(e){let t;try{t=i.statSync(n.startPage).mtimeMs}catch(e){t=(new Date).getTime()}const s={state:"demoLicense",productType:"",registeredTo:"",expiryDate:"",email:"",daysUntilExpiry:"",isBundle:!1,upgradeUrl:"https://wallabyjs.com/purchase/?referrer=qsp#select-quokka",purchaseUrl:"https://wallabyjs.com/purchase/?referrer=qsp#select-quokka",renewUrl:"https://wallabyjs.com/purchase/?referrer=qsp#select-quokka",previousVersionUrl:"https://quokkajs.com/docs/previous.html",newInstall:!1,installTime:t};try{JSON.parse(i.readFileSync(n.quokkaConfigPath).toString()).pro||(s.state="community")}catch(e){s.newInstall=!0,s.state="community"}if("community"===s.state)return s;try{const e=JSON.parse(Buffer.from(i.readFileSync(n.olp).toString(),"base64").toString());s.email=e.quokkaEmail||"",s.registeredTo=s.email,s.onlineLicense=!!e.quokkaEmail,s.state="activating"}catch(e){}try{const t=i.readFileSync(n.lkp).toString().split(":").reduce((e,t)=>t.trim());if(t.length<50){if(!s.onlineLicense)try{parseInt(t,10)+1314e6<+new Date&&(s.state="trialDemoOver")}catch(e){s.state="trialDemoOver"}}else{const i=Buffer.from(t,"base64").toString().split("\n"),[a,o,,,r,l]=i[1].split(",");s.registeredTo=i[0],s.email=s.email||a,s.isBundle=!!~o.indexOf("Wallaby.js");const c=!!~o.toLowerCase().indexOf("company")||!!~o.toLowerCase().indexOf("enterprise"),h="wallabyjs@gmail.com"===a||"1"===l;s.isBundle?s.productType="Wallaby.js + Quokka.js":s.productType="Quokka.js";const[u,d,_]=i[2].split("/").map(e=>parseInt(e,10));s.expiryDate=u+" "+n.monthNames[d-1]+", "+_;let p=!1;const m=new Date(Date.UTC(_,d-1,u)),g=new Date,v=Math.floor((m.getTime()-g.getTime())/864e5);s.daysUntilExpiry=`${v} day${1===v?"":"s"}`,v<0?h?s.state="trialDemoOver":(e.setHours(0,0,0,0),m.setHours(0,0,0,0),m<e?(s.previousVersionUrl="https://quokkajs.com/docs/previous.html?expirydate="+m.getUTCFullYear()+"-"+(m.getUTCMonth()+1)+"-"+m.getUTCDate(),s.state="expiredWrongVersion",s.key=t,p=!0):(s.state="expired",s.key=t,p=!0)):v<=14?h?s.state="trialLicense":(s.state="expiring",s.key=t,p=!0):h?s.state="trialLicense":(s.state="activated",s.key=t,p=!0),p&&!c&&(c?(s.purchaseUrl="https://wallabyjs.com/store/company/?referrer=qsp#select-quokka",r?(s.upgradeUrl=`https://wallabyjs.com/store/personal/?renewalOrder=${r}&upgrade=1&referrer=qsp`,s.renewUrl=`https://wallabyjs.com/store/personal/?renewalOrder=${r}&referrer=qsp`):(s.upgradeUrl="https://wallabyjs.com/store/company/?referrer=qsp#select-quokka",s.renewUrl="https://wallabyjs.com/store/company/?referrer=qsp#select-quokka")):(s.upgradeUrl=`https://wallabyjs.com/store/personal/?renewalEmail=${encodeURIComponent(a)}&upgrade=1&referrer=qsp`,s.renewUrl=`https://wallabyjs.com/store/personal/?renewalEmail=${encodeURIComponent(a)}&referrer=qsp`))}}catch(e){}return s}}s.LicenseReader=n,n.monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],n.quokkaFolder=o.join(a.homedir(),".quokka"),n.wallabyFolder=o.join(a.homedir(),".wallaby"),n.lkp=o.join(n.quokkaFolder,".qlc"),n.quokkaConfigPath=o.join(n.quokkaFolder,"config.json"),n.olp=o.join(n.wallabyFolder,".ol"),n.startPage=o.join(n.quokkaFolder,"startPage.json")},{fs:void 0,os:void 0,path:void 0}],8:[function(e,t,s){"use strict";const i=e("vscode"),a=global._,o={text:"",link:Array(2).join("​"),error:{start:"",end:" "},duration:Array(4).join("​"),suite:Array(5).join("​"),message:{start:"",end:" ",altEnd:" "+Array(6).join("​")},diffIns:Array(2).join("‌⁠"),diffDel:Array(2).join("‍"),tmpDiffIns:{start:"wsDiffIns",end:"weDiffIns"},tmpDiffDel:{start:"wsDiffDel",end:"weDiffDel"}};t.exports=class{constructor(e,t,s,o,n,r,l,c,h,u){this._lines=[],this._links=[],this._quokkaFileName=t,this._displayedFileName=h,this._contentLimit=1048576,this._channel=e,this._absolutePathResolver=s,this._dmp=o,this._hasOpenedProject=l,this.render=a.debounce(a.bind(this.render,this),300),this._header="Quokka",this.isLiveShareClient=c,this.disposed=!1,this.channelEnabled=!0,this._messageSeparator=u?"":"\n",this.useMarkup(),n.add(i.languages.registerDocumentLinkProvider(r,{provideDocumentLinks:e=>{if(!this.channelEnabled||this.disposed)return[];const t=e.lineAt(0);return t&&t.text&&~t.text.indexOf(this._header)?this._links:[]}}))}enableChannel(){this.channelEnabled=!0}disableChannel(){this.channelEnabled=!1}useMarkup(){this._markupTokens=a.extend({},o)}disableMarkup(){this._markupTokens.text=this._markupTokens.link=this._markupTokens.error=this._markupTokens.duration=this._markupTokens.suite=this._markupTokens.message=""}dispose(){this.disposed=!0}build(e){this._lines=[],this._links=[],this._appendLine("text",0,this._header),a.isString(e)?this._appendLine("error",0,e):a.isObject(e)&&(a.each(e.errors,e=>this._outputError(e)),a.each(e.messages,e=>this._outputMessage(e)))}lines(){return this._lines}render(){this._doRender()}_doRender(e){if(this.disposed||!this.channelEnabled)return;(e=e||0)||(this._channel.clear(),this._channel.append("​"));let t="";for(let s=e,i=this._lines.length;s<i;s++)if((t+=this._lines[s]+"\n").length>this._contentLimit){t+="\n--- output truncated to "+this._contentLimit+" bytes ---\n";break}this._channel.append(t.replace(/\u0000/g,""))}clear(){this._lines=[],this._links=[]}clearAndRenderHeader(){this.clear(),this._appendLine("text",0,this._header),this._doRender()}appendConsoleMessage(e){const t=this._lines.length;this._outputMessage(e),this._doRender(t)}show(){this.disposed||this._channel.show(!0)}areDifferent(e,t){return e!==t}setContentLimit(e){e&&(this._contentLimit=e)}setHeaderData(e){if(this.disposed)return;let t=e.plugins||[];e.builtInPlugins&&t.push(...e.builtInPlugins),t.sort((e,t)=>e.localeCompare(t));try{this._header=this._markupStartToken("suite")+"Quokka '"+this._displayedFileName+"'"+` (node: ${e.nodeVersion}${e.ts?`, TypeScript: ${e.ts.version&&"v"+e.ts.version||"unknown version"}`:""}${e.babel?`, babel: ${e.babel.version&&"v"+e.babel.version||"unknown version"}`:""}${t.length?`, plugins: ${t.join(", ")}`:""})${this._markupStartToken("suite")}`}catch(e){console.log(e)}}_markupStartToken(e){const t=this._markupTokens[e];return a.isObject(t)?t.start:t}_markupEndToken(e){const t=this._markupTokens[e];return a.isObject(t)?t.end:t}_markupAltEndToken(e){const t=this._markupTokens[e];return a.isObject(t)?t.altEnd||t.end:t}_outputMessage(e){if("diff"===e.type){if(!e.context&&!e.actual&&!e.expected)return;e.text=e.context,delete e.context}e.context&&e.context.replace&&(e.context=e.context.replace(/\r\n\s*/g," ").replace(/\n\s*/g," "));const t=e.text&&(e.text.length>20||~e.text.indexOf("\n"))&&"diff"!==e.type;let s="error"===e.type?"error":"warn"===e.type||"diff"===e.type?"duration":"message";if(t)this._appendLine(s,0,this._messageSeparator+e.text),this._outputLink(e,1);else{"diff"===e.type&&this._outputDiff(0,e.expected,e.actual);let t=e.text?`${this._messageSeparator}${this._markupStartToken(s)}${e.text}${this._markupAltEndToken(s)}`:"";if(e.file){"message"!==s&&(t+=" ");const i=this._markupStartToken("link")+e.file+(e.loc?":"+e.loc:"")+this._markupEndToken("link");t+="at "+(e.context?this._markupStartToken("duration")+e.context+this._markupEndToken("duration")+" ":""),t+=i,this._addFileLink(e.file,e.loc,i,t.length-i.length,this._lines.length+(t.split(/\r\n|\r|\n/).length-1))}this._appendLine("text",0,t)}}_outputError({message:e,stack:t,expected:s,actual:i,missingPackage:o,missingBrowserGlobal:n}){let r=this;this._outputDiff(0,s,i),o&&!this.isLiveShareClient&&(this._addEmptyLine(),this._addCustomLinkLine(`Install "${o}" package for the current quokka file`,"command:quokka.installMissingPackageToQuokka",0),this._hasOpenedProject&&this._addCustomLinkLine(`Install "${o}" package into the project`,"command:quokka.installMissingPackageToProject",0)),n&&!this.isLiveShareClient&&(this._addEmptyLine(),this._appendLine("duration",0,`"${n}" looks like a browser global`),this._addCustomLinkLine("Install and use quokka browser plugin",`command:quokka.installQuokkaPlugin?${encodeURIComponent(JSON.stringify(["jsdom","jsdom-quokka-plugin"]))}`,0),this._addCustomLinkLine("Open quokka browser plugin documentation","https://quokkajs.com/docs/configuration.html#jsdom",0)),this._appendLine("error",0,this._messageSeparator+e),a.each(t,e=>r._outputLink(e,1))}_outputDiff(e,t,s){if(this._dmp&&(t||s)){let i="\n"+this._dmp.diff_prettyHtml(this._dmp.diff_wordMode(t||"",s||"")).replace(/&para;<br>/g,"\n").replace(/<br>/g,"\n").replace(/<\/?span[^>]*>/g,"").replace(/<ins[^>]*>/g,this._markupStartToken("tmpDiffIns")).replace(/<del[^>]*>/g,this._markupStartToken("tmpDiffDel")).replace(/<\/ins[^>]*>/g,this._markupEndToken("tmpDiffIns")).replace(/<\/del[^>]*>/g,this._markupEndToken("tmpDiffDel")).replace(/style="background:#e6ffe6;"/g,"").replace(/style="background:#ffe6e6;"/g,"").replace(/&lt;/g,"<").replace(/&amp;/g,"&").replace(/&gt;/g,">"),a=0,o=0;this._appendLine("none",e,i,void 0,void 0,e=>{if(!e)return e;a>0&&(e=this._markupStartToken("diffIns")+e),o>0&&(e=this._markupStartToken("diffDel")+e);let t=(e.match(new RegExp(this._markupStartToken("tmpDiffIns"),"g"))||[]).length,s=(e.match(new RegExp(this._markupEndToken("tmpDiffIns"),"g"))||[]).length;a+=t-s;let i=(e.match(new RegExp(this._markupStartToken("tmpDiffDel"),"g"))||[]).length,n=(e.match(new RegExp(this._markupEndToken("tmpDiffDel"),"g"))||[]).length;return o+=i-n,a>0&&(e+=this._markupEndToken("diffIns")),o>0&&(e+=this._markupEndToken("diffDel")),e.replace(new RegExp(this._markupStartToken("tmpDiffIns"),"g"),this._markupStartToken("diffIns")).replace(new RegExp(this._markupEndToken("tmpDiffIns"),"g"),this._markupEndToken("diffIns")).replace(new RegExp(this._markupStartToken("tmpDiffDel"),"g"),this._markupStartToken("diffDel")).replace(new RegExp(this._markupEndToken("tmpDiffDel"),"g"),this._markupEndToken("diffDel"))})}}_outputLink(e,t){if(e.file){var s=e.file+(e.loc?":"+e.loc:"");this._appendLine("link",t,s,void 0,e.context,(t,i)=>{this._addFileLink(e.file,e.loc,s,i)})}}_addCustomLinkLine(e,t,s){let a=this._lines.length;this._appendLine("text",s,this._markupStartToken("link")+e+this._markupEndToken("link")),this._links.push({range:new i.Range(a,this._markupStartToken("link").length,a,e.length+this._markupEndToken("link").length),target:i.Uri.parse(t)})}_addFileLink(e,t,s,a,o){"."!==e[0]&&e!==this._quokkaFileName||(o=o||this._lines.length,this._links.push({range:new i.Range(o,a,o,a+s.length),target:0===e.indexOf("quokka")?i.Uri.parse("command:quokka.goToLineInQuokkaFile?"+JSON.stringify(this._location(t).substring(1))):i.Uri.parse(i.Uri.file(this._absolutePathResolver(e)).toString()+this._location(t,0))}))}_location(e,t){let s,i;return a.isNumber(e)?s=e:a.isArray(e)?(s=e[0],i=e[1]):a.isString(e)&&(s=(e=e.split(":"))[0]&&parseInt(e[0],10),i=e[1]&&parseInt(e[1],10)),a.isNumber(i)&&(i+=void 0!==t?t:1)<0&&(i=0),"#"+(a.isNumber(i)?`${s},${i}`:s)}_addEmptyLine(){this._appendLine("text",0,"")}_appendLine(e,t,s,i,o,n){let r=this,l=s.split("\n"),c=[this._markupStartToken(e)||"",this._markupEndToken(e)||""];a.each(l,s=>{const l=(i?`[${i}] `:"")+a.pad("",2*t,"   ")+("link"===e?"at "+(o?this._markupStartToken("duration")+o+this._markupEndToken("duration")+" ":""):"")+c[0];let h=l+s+c[1];if(n){let e=n(h,l.length);e&&(h=e)}r._lines.push(h)})}}},{vscode:void 0}],9:[function(e,t,s){"use strict";var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))(function(a,o){function n(e){try{l(i.next(e))}catch(e){o(e)}}function r(e){try{l(i.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(n,r)}l((i=i.apply(e,t||[])).next())})};const a=e("vscode"),o=e("path"),n=e("util"),r=e("fs"),l=e("os"),c=n.promisify(r.readFile),h=n.promisify(r.writeFile),u=e=>c(e).then(e=>e.toString()),d=e=>u(e).catch(()=>""),_=e("./compositeDisposable"),p="quokka-recent",m=a.Uri.parse("quokka-recent:Recent Quokka Files");class g{constructor(e){this._disposables=new _,this._onDidChange=new a.EventEmitter,this._quokkaFolder=e,this._quokkaRecentFilesMetadataPath=o.join(e,"recentFiles.json"),this._quokkaRecentFilesFolderPath=o.join(e,"recentFiles"),this._disposables.add(a.languages.registerCodeLensProvider([p],this)),this._disposables.add(a.workspace.registerTextDocumentContentProvider(p,this)),this.reset()}findRecentScratchFileIdByContent(e){return i(this,void 0,void 0,function*(){if(!e)return;e=e.trim();const t=yield this._getMetadata();if(!t||!t.projects)return;const s=Object.keys(t.projects);let i=0;for(;s.length;){const a=t.projects[s.pop()];if(a){const t=Object.values(a);for(let s of t)if(s.scratchFile){if((s.content&&s.content.trim())===e)return s.fileId;if(++i>=5)return}}}})}reset(){delete this._metadata}dispose(){this._disposed||(this._disposables.dispose(),this._disposed=!0)}show(e){return i(this,void 0,void 0,function*(){if(this.reset(),this._content=yield this._buildContent(e||this._quokkaFolder),!this._content)return;this._onDidChange.fire(m);const t=yield a.window.showTextDocument(m);t.options.lineNumbers=a.TextEditorLineNumbersStyle.Off,a.languages.setTextDocumentLanguage(t.document,p)})}get onDidChange(){return this._onDidChange.event}static prepareContentText(e){return e.replace(/ /g," ")}static formatProjectDir(e){return e.replace(l.homedir(),"~")}static pathToMetadataKey(e){return e&&"win32"===process.platform?e.toLowerCase():e}removeRecentFiles(e){return i(this,void 0,void 0,function*(){let t;try{t=JSON.parse(yield u(this._quokkaRecentFilesMetadataPath))}catch(e){}if(!t||!t.projects)return;const s=Object.keys(t.projects);for(;s.length;){const i=s.pop(),a=t.projects[i];if(a)for(let t of e)g.pathToMetadataKey(t.projectRoot)===i&&delete a[t.id]}try{yield h(this._quokkaRecentFilesMetadataPath,JSON.stringify(t))}catch(e){}})}_buildContent(e){return i(this,void 0,void 0,function*(){const t=yield this._getMetadata();if(!t||!t.projects)return;this._lenses=[];const s=g.pathToMetadataKey(e);let i=[];const n=e=>{const t=`${e.modificationDate.toLocaleDateString()} ${e.modificationDate.toLocaleTimeString()}`;let o,n;s===e.projectRootKey||g.pathToMetadataKey(this._quokkaFolder)===e.projectRootKey?o=e.path:(o=e.resolvedPath,n=!0),i.push({text:`⁠${g.formatProjectDir(o)}⁠  ${t} `});const r=(()=>i.length-1)();if(this._lenses.push(new a.CodeLens(new a.Range(r,0,r,0),{title:"Run",tooltip:"Run",command:"quokka.runRecentFile",arguments:[e]})),e.scratchFile&&this._lenses.push(new a.CodeLens(new a.Range(r,0,r,0),{title:"Clone and Run",tooltip:"Clone and Run",command:"quokka.runRecentFile",arguments:[Object.assign({clone:!0},e)]})),n){const t=g.formatProjectDir(e.projectRoot);this._lenses.push(new a.CodeLens(new a.Range(r,0,r,0),{title:"Run in "+t,tooltip:"Run in "+t,command:"quokka.runRecentFile",arguments:[Object.assign({runInParentProject:!0},e)]})),e.scratchFile&&this._lenses.push(new a.CodeLens(new a.Range(r,0,r,0),{title:"Clone and Run in "+t,tooltip:"Clone and Run in "+t,command:"quokka.runRecentFile",arguments:[Object.assign({clone:!0,runInParentProject:!0},e)]}))}this._lenses.push(new a.CodeLens(new a.Range(r,0,r,0),{title:"Remove from recent files",tooltip:"Remove from recent files",command:"quokka.removeRecentFiles",arguments:[{files:[e],reloadRecentFilesView:!0}]})),i.push({text:"​"})},r=t.projects[s];r&&(delete t.projects[s],t.projects[s]=r);const l=Object.keys(t.projects),c=[];for(;l.length;){const e=l.pop(),s=t.projects[e];if(s){const t=Object.values(s).reverse();for(let s of t){s.scratchFile&&(s.path=s.path.replace("quokka","scratch")),s.projectRootKey=e,s.resolvedPath=o.resolve(s.projectRoot,s.path),s.id=s.fileId||g.pathToMetadataKey(s.path);const t=s.content||(yield d(s.scratchFile?o.join(this._quokkaRecentFilesFolderPath,s.fileId):s.resolvedPath));if(!t){c.push(s);continue}s.content=t.trim(),s.modificationDate=new Date(s.ts),n(s);const a=s.content.split(/\r\n|\r|\n/).map(e=>({text:`  ${e}`}));(i=i.concat(a)).push({text:"​"})}}}return c.length&&a.commands.executeCommand("quokka.removeRecentFile",{files:c}),{lines:i,text:i.map(e=>e.text).join("\n"),annotationDecorations:[]}})}provideTextDocumentContent(){return this._content&&this._content.text||""}provideCodeLenses(e){return this._lenses||[]}_getMetadata(){return i(this,void 0,void 0,function*(){if(this._metadata)return this._metadata;try{this._metadata=JSON.parse(yield u(this._quokkaRecentFilesMetadataPath))}catch(e){this._metadata={projects:{}}}return this._metadata})}}t.exports=g},{"./compositeDisposable":5,fs:void 0,os:void 0,path:void 0,util:void 0,vscode:void 0}],10:[function(e,t,s){"use strict";var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))(function(a,o){function n(e){try{l(i.next(e))}catch(e){o(e)}}function r(e){try{l(i.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(n,r)}l((i=i.apply(e,t||[])).next())})};const a=e("vscode"),o=e("util"),n=e("path"),r=e("fs"),l=e("os"),c=e("./licenseReader").LicenseReader;class h{constructor(e,t){this._disposables=[],this._checkOffersResults=void 0,this._panel=e,this._context=t,this._extensionUri=t.extensionUri,this._pendingMessages=[],this._initialized=!1,this._panel.iconPath=a.Uri.file(t.asAbsolutePath("media/logo.svg")),this._load()}static setController(e){h.controller=e}static getStartViewWhatsNewVersion(e){return i(this,void 0,void 0,function*(){const t=a.Uri.joinPath(e.extensionUri,"media","index.html"),s=[...new o.TextDecoder("utf8").decode(yield a.workspace.fs.readFile(t)).matchAll(/data-whats-new-version=["|'](\d+)["|']/gm)];return Math.max(...s.map(e=>{const[,t]=e;return parseInt(t,10)}))})}static showWhatsNewIfRequired(e){return i(this,void 0,void 0,function*(){if(!a.workspace.getConfiguration().get("quokka.showStartViewOnFeatureRelease",!0))return!1;try{if((yield h.getStartViewWhatsNewVersion(e))>h._getUserWhatsNewVersion())return h.createOrShow(e,{type:"whatsnew"}),!0}catch(e){console.log(e)}return!1})}static createOrShow(e,t){const s=a.window.activeTextEditor?a.window.activeTextEditor.viewColumn:void 0;if(h.currentPanel)return h.currentPanel._panel.reveal(s),void h.currentPanel._processAction(e,t);const i=a.window.createWebviewPanel(h.viewType,"Quokka",s||a.ViewColumn.One,{enableScripts:!0,localResourceRoots:[a.Uri.joinPath(e.extensionUri)]});h.currentPanel=new h(i,e),h.currentPanel._processAction(e,t)}_processAction(e,t){return i(this,void 0,void 0,function*(){if(t)switch(t.type){case"activate":h.currentPanel.activateLicense(t);break;case"trial":h.currentPanel.requestTrial(t);break;case"goToLicenseSection":h.currentPanel.goToLicenseSection(t);break;case"showAllWhatsNew":h.currentPanel.showWhatsNew(!0),h.currentPanel._panel.title="Quokka: What's New";break;case"whatsnew":h.currentPanel.showWhatsNew(!1),h.currentPanel._panel.title="Quokka: What's New";break;case"firstInstall":const s=yield h.getStartViewWhatsNewVersion(e);h.controller&&h.controller._salesEvent&&h.controller._salesEvent.setLastUrlOpenedTime(),h._saveUserWhatsNewVersion(s),h.currentPanel.firstInstall(t)}})}static revive(e,t){h.currentPanel&&h.currentPanel.dispose(),h.currentPanel=new h(e,t)}activateLicense(){this._pendingMessages.push({command:"activateLicense"}),this.processPendingMessages()}firstInstall(e){this._pendingMessages.push(Object.assign({command:"firstInstall"},e)),this.processPendingMessages()}goToLicenseSection(){this._pendingMessages.push({command:"goToLicenseSection"}),this.processPendingMessages()}requestTrial(){this._pendingMessages.push({command:"requestTrial"}),this.processPendingMessages()}showWhatsNew(e){const t=e?0:h._getUserWhatsNewVersion();this._pendingMessages.push({command:"showWhatsNew",previousWhatsNewVersion:t}),this.processPendingMessages()}processPendingMessages(){if(this._initialized){const e=this._pendingMessages;this._pendingMessages=[],e.forEach(e=>{this._panel.webview.postMessage(e)})}}_getGlobalConfigSettings(){try{return Object.assign(Object.assign({},h.globalDefaults),JSON.parse(r.readFileSync(h.quokkaConfigPath)))}catch(e){return Object.assign({},h.globalDefaults)}}_saveGlobalConfigSettings(e){e=Object.assign({},e),Object.keys(h.globalDefaults).forEach(t=>{e[t]===h.globalDefaults[t]&&delete e[t]}),r.writeFileSync(h.quokkaConfigPath,JSON.stringify(e)),this._panel.webview.postMessage({command:"globalConfig",globalConfig:this._getGlobalConfigSettings()})}_load(){this._update().then(()=>{this._panel.onDidDispose(()=>this.dispose(),null,this._disposables),this._panel.onDidChangeViewState(()=>{this._panel.visible?this._update():this._initialized=!1},null,this._disposables);const e=e=>{const t=a.workspace.getConfiguration().inspect(e);return void 0!==t.globalValue?t.globalValue:t.defaultValue};this._panel.webview.onDidReceiveMessage(t=>{switch(t.command){case"requestInitialState":const s=e("quokka.compactMessageOutput"),i=e("quokka.showOutputOnStart"),o=e("quokka.startViewStatusBar"),n=e("quokka.suppressExpirationNotifications"),l=e("quokka.showStartViewOnFeatureRelease"),c=e("quokka.automaticRestart"),u=e("quokka.automaticStartRegex"),d=h.controller&&h.controller._buildDate||new Date;return d.setHours(0,0,0),this._panel.webview.postMessage({command:"initialState",settings:{compactMessageOutput:s,showOutputOnStart:i,startViewStatusBar:o,suppressExpirationNotifications:n,showStartViewOnFeatureRelease:l,automaticRestart:c,automaticStartRegex:u},globalConfig:this._getGlobalConfigSettings(),licenseDetails:h.getLicenseDetails(),whatsNewVersion:h._getUserWhatsNewVersion(),buildDate:d}),this._initialized=!0,void this.processPendingMessages();case"saveGlobalConfig":this._saveGlobalConfigSettings(t.globalConfig);break;case"updateSetting":a.workspace.getConfiguration().update("quokka."+t.setting,t.value,a.ConfigurationTarget.Global);break;case"otherSettings":a.commands.executeCommand("workbench.action.openSettings","quokka");break;case"configJson":r.existsSync(h.quokkaConfigPath)||r.writeFileSync(h.quokkaConfigPath,JSON.stringify({})),a.workspace.openTextDocument(h.quokkaConfigPath).then(e=>a.window.showTextDocument(e));break;case"useCommunityEdition":this._useCommunityEdition();break;case"switchToPro":this._usePro();break;case"launchDemo":this._launchDemo();case"trialRequest":this._requestTrialLicense(t.email);break;case"activateLicense":this._activateLicense(t);break;case"updateWhatsNewVersion":h._saveUserWhatsNewVersion(t.version);break;case"log":console.log(t)}},null,this._disposables)})}_launchDemo(){return i(this,void 0,void 0,function*(){if(h.controller){const e=a.Uri.joinPath(this._extensionUri,"media","interactive-demo.js");let t=new o.TextDecoder("utf8").decode(yield a.workspace.fs.readFile(e));"darwin"===process.platform&&(t=t.replace(/`Ctrl/gm,"`⌘")),h.controller._createLanguageFile("JavaScript",t)}})}_useCommunityEdition(){try{let e;try{e=JSON.parse(r.readFileSync(h.quokkaConfigPath))}catch(t){e={}}e.pro=!1,r.writeFileSync(h.quokkaConfigPath,JSON.stringify(e))}catch(e){}this._panel.webview.postMessage({command:"switchToCommunityEdition",licenseDetails:h.getLicenseDetails()})}_usePro(){try{let e;try{e=JSON.parse(r.readFileSync(h.quokkaConfigPath))}catch(t){e={}}e.pro=!0,r.writeFileSync(h.quokkaConfigPath,JSON.stringify(e))}catch(e){}this._panel.webview.postMessage({command:"switchToPro",licenseDetails:h.getLicenseDetails()})}_activateLicense({email:e,key:t}){if(!h.controller)return void this._panel.webview.postMessage({command:"activationError",message:"VS Code has not finished loading, please try and activate again later."});const s=new Date;let i=!1;h.controller.processLicenseChange(e||t,e=>{if(!i){i=!0;const t=new Date-s,a=e=>t<500?setTimeout(e,500-t):e();"notification"===e.type&&(e=e.text),"info"===e.type||"warning"===e.type?a(()=>this._panel.webview.postMessage({command:"activationSuccess",message:e.text,licenseDetails:h.getLicenseDetails()})):a(()=>this._panel.webview.postMessage({command:"activationError",message:e.text}))}}),e&&setTimeout(()=>{i||(i=!0,this._panel.webview.postMessage({command:"activationError",message:"A timeout occurred while attempting to validate your email address."}))},25e3)}_requestTrialLicense(t){const s=e("https"),i=JSON.stringify({email:t,type:"quokka",referrer:"qsp"}),a={hostname:"x55r2pae4l.execute-api.us-east-1.amazonaws.com",port:443,path:"/Prod/bc88894221b34ae4adac5c39a51547a2",method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(i)}},o=s.request(a,e=>{200===e.statusCode?this._panel.webview.postMessage({command:"trialRequestSuccess"}):this._panel.webview.postMessage({command:"trialRequestError"})});o.on("error",e=>{this._panel.webview.postMessage({command:"trialRequestError"}),console.error(e)}),o.write(i),o.end()}static _checkForOffers(t){if(h.controller&&h.controller._salesEvent&&h.controller._salesEvent.saleInProgress())return void t({displayDiscount:!1,sale:!0,saleDiscount:h.controller._salesEvent.discountAmount()});if(void 0!==h._checkOffersResults)return void(h._checkOffersResults.discount&&h._checkOffersResults.discount>5?t(h._checkOffersResults):t({displayDiscount:!1}));const s=e("https"),i=JSON.stringify({product:"quokka"}),a={hostname:"x55r2pae4l.execute-api.us-east-1.amazonaws.com",port:443,path:"/Prod/checkOffers",method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(i)}};let o=!1;const n=s.request(a,e=>{let s="";e.on("data",e=>{s+=e}),e.on("end",()=>{if(200===e.statusCode){const e=JSON.parse(s);e.discount=Math.floor(100-100*e.offer_price/e.list_price),o||(o=!0,e.displayDiscount=e.discount>5,e.displayDiscount||(e.discount=0),h.controller&&h.controller._salesEvent&&h.controller._salesEvent.saleInProgress()&&(e.sale=!0,e.saleDiscount=h.controller._salesEvent.discountAmount()),h._checkOffersResults=e,t(e))}})});n.on("error",e=>{console.error(e),h._checkOffersResults={},t({displayDiscount:!1})}),n.write(i),n.end(),setTimeout(()=>{o||(o=!0,h._checkOffersResults={},t({displayDiscount:!1}))},15e3)}static _getUserWhatsNewVersion(){try{return JSON.parse(Buffer.from(r.readFileSync(h.startPage).toString())).version}catch(e){return 0}}static _saveUserWhatsNewVersion(e){try{r.writeFileSync(h.startPage,JSON.stringify({version:e}))}catch(e){console.error(e)}}static getLicenseDetails(){const e=h.controller&&h.controller._buildDate||new Date,t=c.getLicenseDetails(e);var s;return"community"===t.state&&h._checkForOffers(e=>{e&&h.currentPanel&&h.currentPanel._panel&&h.currentPanel._panel.webview.postMessage({command:"countryDiscount",offer:{discount:e.discount,country:(s=e.country,{AF:"Afghanistan",AL:"Albania",DZ:"Algeria",AS:"American Samoa",AD:"Andorra",AO:"Angola",AI:"Anguilla",AG:"Antigua and Barbuda",AR:"Argentina",AM:"Armenia",AW:"Aruba",AU:"Australia",AT:"Austria",AZ:"Azerbaijan",BS:"Bahamas",BH:"Bahrain",BD:"Bangladesh",BB:"Barbados",BY:"Belarus",BE:"Belgium",BZ:"Belize",BJ:"Benin",BM:"Bermuda",BT:"Bhutan",BO:"Bolivia",BA:"Bosnia and Herzegovina",BW:"Botswana",BV:"Bouvet Island",BR:"Brazil",IO:"Brit. Indian Ocean",VG:"British Virgin Islands",BN:"Brunei Darussalam",BG:"Bulgaria",BF:"Burkina Faso",BI:"Burundi",KH:"Cambodia",CM:"Cameroon",CA:"Canada",CV:"Cape Verde",KY:"Cayman Islands",CF:"Central African Republic",TD:"Chad",CL:"Chile",CN:"China",CX:"Christmas Island",CC:"Cocos Islands",CO:"Colombia",KM:"Comoros",CG:"Congo",CK:"Cook Islands",CR:"Costa Rica",CI:"Cote D’Ivoire",HR:"Croatia",CU:"Cuba",CW:"Curaçao",CY:"Cyprus",CZ:"Czech Republic",DK:"Denmark",DJ:"Djibouti",DM:"Dominica",DO:"Dominican Republic",EC:"Ecuador",EG:"Egypt",SV:"El Salvador",GQ:"Equatorial Guinea",ER:"Eritrea",EE:"Estonia",ET:"Ethiopia",FK:"Falkland Islands",FO:"Faroe Islands",FJ:"Fiji",FI:"Finland",FR:"France",GF:"French Guiana",PF:"French Polynesia",TF:"French Southern Terr.",GA:"Gabon",GM:"Gambia",GE:"Georgia",DE:"Germany",GH:"Ghana",GI:"Gibraltar",GR:"Greece",GL:"Greenland",GD:"Grenada",GP:"Guadeloupe",GU:"Guam",GT:"Guatemala",GG:"Guernsey",GN:"Guinea",GW:"Guinea-Bissau",GY:"Guyana",HT:"Haiti",HM:"Heard/ Mcdonald Islands",VA:"Holy See/ Vatican City",HN:"Honduras",HK:"Hong Kong",HU:"Hungary",IS:"Iceland",IN:"India",ID:"Indonesia",IR:"Iran",IQ:"Iraq",IE:"Ireland",IL:"Israel",IT:"Italy",JM:"Jamaica",JP:"Japan",JE:"Jersey",JO:"Jordan",KZ:"Kazakhstan",KE:"Kenya",KI:"Kiribati",KW:"Kuwait",KG:"Kyrgyzstan",LA:"Lao People’s DR",LV:"Latvia",LB:"Lebanon",LS:"Lesotho",LR:"Liberia",LY:"Libyan Arab Jamahiriya",LI:"Liechtenstein",LT:"Lithuania",LU:"Luxembourg",MO:"Macao",MK:"Macedonia",MG:"Madagascar",MW:"Malawi",MY:"Malaysia",MV:"Maldives",ML:"Mali",MT:"Malta",MH:"Marshall Islands",MQ:"Martinique",MR:"Mauritania",MU:"Mauritius",YT:"Mayotte",MX:"Mexico",FM:"Micronesia",MD:"Moldova",MC:"Monaco",MN:"Mongolia",ME:"Montenegro",MS:"Montserrat",MA:"Morocco",MZ:"Mozambique",MM:"Myanmar",NA:"Namibia",NR:"Nauru",NP:"Nepal",NL:"Netherlands",AN:"Netherlands Antilles",NC:"New Caledonia",NZ:"New Zealand",NI:"Nicaragua",NE:"Niger",NG:"Nigeria",NU:"Niue",NF:"Norfolk Island",KP:"North Korea",MP:"Northern Mariana Islands",NO:"Norway",OM:"Oman",PK:"Pakistan",PW:"Palau",PS:"Palestinian Territory",PA:"Panama",PG:"Papua New Guinea",PY:"Paraguay",PE:"Peru",PH:"Philippines",PN:"Pitcairn",PL:"Poland",PT:"Portugal",PR:"Puerto Rico",QA:"Qatar",RS:"Republic of Serbia",RE:"Reunion",RO:"Romania",RU:"Russian Federation",RW:"Rwanda",GS:"S. Georgia/ Sandwich Islands",SH:"Saint Helena",KN:"Saint Kitts and Nevis",LC:"Saint Lucia",PM:"Saint Pierre and Miquelon",VC:"Saint Vincent/ Grenadines",WS:"Samoa",SM:"San Marino",ST:"Sao Tome and Principe",SA:"Saudi Arabia",SN:"Senegal",SC:"Seychelles",SL:"Sierra Leone",SG:"Singapore",SK:"Slovakia",SI:"Slovenia",SB:"Solomon Islands",SO:"Somalia",ZA:"South Africa",KR:"South Korea",ES:"Spain",LK:"Sri Lanka",SD:"Sudan",SR:"Suriname",SJ:"Svalbard and Jan Mayen",SZ:"Swaziland",SE:"Sweden",CH:"Switzerland",SY:"Syrian Arab Republic",TW:"Taiwan",TJ:"Tajikistan",TZ:"Tanzania",TH:"Thailand",TL:"Timor-Leste",TG:"Togo",TK:"Tokelau",TO:"Tonga",TT:"Trinidad and Tobago",TN:"Tunisia",TR:"Turkey",TM:"Turkmenistan",TC:"Turks and Caicos Islands",TV:"Tuvalu",VI:"U.S. Virgin Islands",UG:"Uganda",UA:"Ukraine",AE:"United Arab Emirates",GB:"United Kingdom",US:"United States",UM:"United States (M.O.I.)",UY:"Uruguay",UZ:"Uzbekistan",VU:"Vanuatu",VE:"Venezuela",VN:"Vietnam",WF:"Wallis and Futuna",EH:"Western Sahara",YE:"Yemen",ZM:"Zambia",ZW:"Zimbabwe"}[s]),display:e.displayDiscount,sale:!!e.sale,saleDiscount:e.saleDiscount}})}),t}dispose(){for(h.currentPanel=void 0,this._panel.dispose(),this._panel=void 0;this._disposables.length;){const e=this._disposables.pop();e&&e.dispose()}}_update(){return i(this,void 0,void 0,function*(){const e=this._panel.webview;this._panel.webview.html=yield this._getHtmlForWebview(e)})}_getHtmlForWebview(e){return i(this,void 0,void 0,function*(){const t=a.Uri.joinPath(this._extensionUri,"media","index.html"),s=new o.TextDecoder("utf8").decode(yield a.workspace.fs.readFile(t)),i={nonce:function(){let e="";const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let s=0;s<32;s++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}(),cspSource:e.cspSource,root:e.asWebviewUri(this._extensionUri).toString()};return Object.keys(i).reduce((e,t)=>e.replace(new RegExp(("${"+t+"}").replace(/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g,"\\$&"),"g"),i[t]),s)})}}h.quokkaFolder=n.join(l.homedir(),".quokka"),h.wallabyFolder=n.join(l.homedir(),".wallaby"),h.lkp=n.join(h.quokkaFolder,".qlc"),h.quokkaConfigPath=n.join(h.quokkaFolder,"config.json"),h.olp=n.join(h.wallabyFolder,".ol"),h.startPage=n.join(h.quokkaFolder,"startPage.json"),h.globalDefaults={autoLog:!1,showValueOnSelection:!0,showSingleInlineValue:!0,delay:0,logLimit:100,recycle:!1},h.monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],h.viewType="quokkaStartPage",t.exports=h},{"./licenseReader":7,fs:void 0,https:void 0,os:void 0,path:void 0,util:void 0,vscode:void 0}],11:[function(e,t,s){"use strict";const i=e("vscode"),a=global._;class o{constructor(e){this._context=e,this._docsNode={label:"No logged values, click to see the feature docs",iconPath:this._context.asAbsolutePath("images/question.svg"),command:{command:"vscode.open",arguments:[i.Uri.parse("https://quokkajs.com/docs/#value-explorer")]}},this._treeDataProvider=new l(this._docsNode),this._treeDataProvider._rootNodes={},i.window.registerTreeDataProvider&&i.window.registerTreeDataProvider("quokkaValueExplorer",this._treeDataProvider)}remove(e){const t=this._treeDataProvider._rootNodes,s=t[e.id];delete t[e.id],s&&s._context.cancelPendingUpdates(),this._treeDataProvider.refresh()}update(e,t){let s=this._treeDataProvider._rootNodes[e.id];if(!s){const t=new n(this._context,e);s=new r(t,{label:{name:`${e.id}`},id:e.id,sessionNode:!0,disallowToCopyPath:!0,disallowToCopyData:!0}),this._treeDataProvider._rootNodes[e.id]=s}s._children=a.chain(t).map(e=>{let t=(e.valueBag||{}).data;if(!t)return;t.name||o.removeExcessiveSpacesTabsLineBreaks(e.text||"").startsWith(o.removeExcessiveSpacesTabsLineBreaks(e.context||"").replace(/\.\.\.$/g,""))||(t.name=o.removeExcessiveSpacesTabsLineBreaks(e.context||""));const s=(e.loc||"").split(":")[0];return s&&(t.name=`line ${s}${t.name?`: ${t.name}`:""}`),t.label=t.label||{},t.label.name=t.name,t.context=e.context,t.rootValueNode=!0,t}).filter(e=>!!e).map(e=>new r(s._context,e,s,e.autoExpand)).value(),s._context.runPendingUpdates(),s._children&&s._children.length||(s._children=[this._docsNode]),this._treeDataProvider.refresh()}static removeExcessiveSpacesTabsLineBreaks(e){return e&&e.replace(/\r\n\s*/g," ").replace(/\n\s*/g," ")}}class n{constructor(e,t){this._expressionsToEvaluate={},this._onUpdate=[],this._extensionContext=e,this._session=t,this.id=t.id}asAbsolutePath(e){return this._extensionContext.asAbsolutePath(e)}isPathRequested(e,t){let s=this._expressionsToEvaluate;const i=a.every(e,e=>!!s[e]&&(s=s[e],!0));return i&&t?JSON.stringify(t)===JSON.stringify(s):i}requestNodes(e,t){let s=this._expressionsToEvaluate;a.each(e,e=>{s[e]=s[e]||{},s=s[e]}),t&&(s.props=t.props,s.strLength=t.strLength,s.ranges=t.ranges),this._session.isDisposed()||(this._session.expressionsToEvaluate(this._expressionsToEvaluate),this._session.runTests({file:this._session.fileName}))}scheduleOnUpdate(e){this._onUpdate.push(e)}copyToClipboard(e){!this._session.isDisposed()&&this._session.copyToClipboard(e)}cancelPendingUpdates(){this._onUpdate=[]}runPendingUpdates(){a.each(this._onUpdate,e=>e()),this._onUpdate.length=0}}class r{constructor(e,t,s,a){this._context=e,this._parent=s,this._data=t,this.label=this._createLabel(),this._queryPath=t.queryPath,this.id=(a?"A":"")+this._context.id+"."+t.id,this.iconPath=this._getIconPath(),t.disallowToCopyPath||(this.contextValue+="QuokkaAllowToCopyPath"),t.disallowToCopyData||(this.contextValue+="QuokkaAllowToCopyData"),this._autoExpand=a&&!this._data.cappedProps&&!this._data.capped&&!this._data.loadActionNode&&!this._data.rangeNode&&"string"!==this._data.type&&!this._data.getter&&!this._data.setter,t.sessionNode?this.collapsibleState=2:this.collapsibleState=t.expandable?this._autoExpand?2:1:0,t.rangeNode&&(this._parentArray=s._parentArray||s,this._queryPath=this._parentArray._queryPath),t.sessionNode&&(this.iconPath=i.ThemeIcon.File,this.resourceUri=i.Uri.file(this.id))}getChildren(){if(this._children)return this._children;if("string"===this._data.type)return this._getChildren({strLength:Number.MAX_VALUE});if(this._data.loadActionNode)return this._getChildren({props:Number.MAX_VALUE});const e=(this._data.props||[]).map(e=>new r(this._context,e,this,this._autoExpand)),t=e=>e._data.functionsNode||e._data.loadActionNode||e._data.callStackNode;return this._data.rangeNode||"array"===this._data.type||"Map"===this._data.type||"Set"===this._data.type||e.sort(function(e,s){if(t(e)||t(s))return 0;const i=((e._data.label||{}).name||"").toLowerCase(),a=((s._data.label||{}).name||"").toLowerCase();return i<a?-1:i>a?1:0}),e.length?Promise.resolve(e):this._data.rangeNode?this._getChildren({ranges:{props:JSON.parse(JSON.stringify(this._parentArray._data.props,(e,t)=>(t.props&&(!t.props.length&&t===this._data||t.props.length&&!t.props[0].rangeNode)&&(t.props=!0),t))),length:this._parentArray._data.length}}):this._getChildren()}copyExpressionPath(){(this._data||{}).expressionPath&&this._context.copyToClipboard(this._data.expressionPath.join(""))}copyExpressionData(){this._data&&this._context.copyToClipboard(this._data)}_getChildren(e){return this._context.isPathRequested(this._queryPath,e)?[]:(this._context.requestNodes(this._queryPath,e),new Promise((e,t)=>{this._context.scheduleOnUpdate(e)}))}_getIconPath(){if(this._data.getter)return this._context.asAbsolutePath("images/getter.svg");if(this._data.functionsNode)return this._context.asAbsolutePath("images/function.svg");if(this._data.loadActionNode)return this._context.asAbsolutePath("images/more.svg");if(this._data.error)return this._context.asAbsolutePath("images/error.svg");if(this._data.rangeNode)return this._context.asAbsolutePath("images/range.svg");if(!this._data.sessionNode){if(this._data.type)switch(this._data.type.toLowerCase()){case"string":if(this._data.capped)return this._context.asAbsolutePath("images/cappedString.svg");case"object":case"array":case"number":case"function":case"boolean":case"date":case"regexp":case"symbol":case"null":case"undefined":return this._context.asAbsolutePath(`images/${this._data.type.toLowerCase()}.svg`)}return this._context.asAbsolutePath("images/object.svg")}}_createLabel(){const e=this._data.label;let t="";return e.name&&(t+=e.name),e.type&&(t+=`: ${e.type} `),e.value&&(t+=(e.type?"":": ")+e.value),t}}class l{constructor(e){this._onDidChangeTreeData=new i.EventEmitter,this.onDidChangeTreeData=this._onDidChangeTreeData.event,this._docsNode=e}refresh(){this._onDidChangeTreeData.fire()}getTreeItem(e){return e}getChildren(e){return e?e.getChildren():a.isEmpty(this._rootNodes)?Promise.resolve([this._docsNode]):Promise.resolve(a.chain(this._rootNodes).values().sortBy(e=>e._data.name).value())}}t.exports=o},{vscode:void 0}]},{},[2]);